<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ©ãƒŸã‚ªãƒšãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2C3E50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
</head>
<body>
    <div class="app-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="app-header">
            <div class="header-title">
                <h1>ğŸ›ï¸ ãƒ©ãƒŸã‚ªãƒšãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                <div class="current-time" id="currentTime"></div>
            </div>
            <div class="header-actions">
                <button class="header-btn" onclick="dashboard.showSettings()">âš™ï¸ è¨­å®š</button>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
        <main class="main-dashboard">
            
            <!-- æ™‚é–“è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆ3ã‚«ãƒ©ãƒ æ§‹æˆï¼‰ -->
            <section class="time-display-grid card">
                <div class="time-column">
                    <div class="time-label">é–‹å§‹æ™‚åˆ»</div>
                    <div class="time-value editable" id="workStartTime" onclick="dashboard.editStartTime()">--:--</div>
                    <div class="time-action">æ‰‹å‹•è¨­å®šå¯</div>
                </div>
                
                <div class="time-column primary">
                    <div class="time-label">æœ€çµ‚çµ‚äº†äºˆå®š</div>
                    <div class="time-value" id="finalFinishTime">--:--</div>
                    <div class="time-status" id="finishStatus">æ¥­å‹™é–‹å§‹å‰</div>
                </div>
                
                <div class="time-column">
                    <div class="time-label">æœ¬æ—¥ã®ç›®æ¨™</div>
                    <div class="time-value editable" id="targetEndTime" onclick="dashboard.editTargetTime()">17:00</div>
                    <div class="time-action">å®šæ™‚/æ®‹æ¥­åˆ‡æ›¿</div>
                </div>
            </section>

            <!-- æ“ä½œã‚¨ãƒªã‚¢ -->
            <section class="operation-area">
                
                <!-- ã‚¸ãƒ§ãƒ–è¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="job-input-section">
                    <h3>æ–°ã—ã„ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ </h3>
                    
                    <!-- å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
                    <div class="input-mode-selector">
                        <label class="radio-option">
                            <input type="radio" name="inputMode" value="direct" checked>
                            <span>ç›´æ¥æšæ•°å…¥åŠ›</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="inputMode" value="parts">
                            <span>éƒ¨æ•°è¨ˆç®—</span>
                        </label>
                    </div>

                    <!-- ç›´æ¥å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ -->
                    <div id="directMode" class="input-mode active">
                        <div class="form-group">
                            <label>ç”Ÿç”£æšæ•°</label>
                            <input type="number" id="directSheets" min="1" step="1" placeholder="æšæ•°">
                        </div>
                    </div>

                    <!-- éƒ¨æ•°è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ -->
                    <div id="partsMode" class="input-mode">
                        <div class="form-row">
                            <div class="form-group">
                                <label>æŒ‡ç¤ºéƒ¨æ•°</label>
                                <input type="number" id="partsCopies" min="1" step="1" placeholder="éƒ¨">
                            </div>
                            <div class="form-group">
                                <label>1æšã®é¢æ•°</label>
                                <input type="number" id="partsPages" min="1" step="1" placeholder="é¢">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>äºˆå‚™æšæ•°</label>
                            <input type="number" id="partsExtra" min="0" step="1" value="0" placeholder="äºˆå‚™">
                        </div>
                    </div>

                    <!-- åŠ å·¥æ¡ä»¶ -->
                    <div class="processing-params">
                        <h4>åŠ å·¥æ¡ä»¶</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ç´™ã®é•·ã• (mm)</label>
                                <input type="number" id="paperLength" min="1" step="0.1" placeholder="é•·ã•">
                            </div>
                            <div class="form-group">
                                <label>é‡ã­å¹… (mm)</label>
                                <input type="number" id="overlapWidth" min="0" step="0.1" placeholder="é‡ã­å¹…">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>åŠ å·¥é€Ÿåº¦ (m/min)</label>
                                <input type="number" id="processSpeed" min="0.1" step="0.1" placeholder="é€Ÿåº¦">
                            </div>
                            <div class="form-group">
                                <label>ãƒ•ã‚£ãƒ«ãƒ åˆæœŸæ®‹é‡ (m)</label>
                                <input type="number" id="initialFilmRemaining" min="0" step="0.1" placeholder="åˆæœŸæ®‹é‡ï¼ˆä»»æ„ï¼‰">
                            </div>
                        </div>
                    </div>

                    <!-- ã‚¸ãƒ§ãƒ–æº–å‚™ãƒœã‚¿ãƒ³ -->
                    <div class="job-prepare-button">
                        <button class="btn btn-primary" onclick="dashboard.prepareJob()">
                            ã‚¸ãƒ§ãƒ–ã‚’æº–å‚™
                        </button>
                    </div>
                </div>

                <!-- æ™‚é–“èª¿æ•´ãƒœã‚¿ãƒ³ -->
                <div class="time-controls">
                    <h4>æ™‚é–“ç®¡ç†</h4>
                    <div class="time-btn-grid">
                        <button class="time-btn" onclick="dashboard.startWork()">æ¥­å‹™é–‹å§‹</button>
                        <button class="time-btn" onclick="dashboard.addLunchBreak()">æ˜¼ä¼‘ã¿è¿½åŠ </button>
                        <button class="time-btn" onclick="dashboard.addManualTime()">æ‰‹å‹•ã§æ™‚é–“è¿½åŠ </button>
                        <button class="time-btn" onclick="dashboard.addExchangeTime()">äº¤æ›æ™‚é–“è¿½åŠ </button>
                    </div>
                </div>


            </section>

            <!-- ã‚¸ãƒ§ãƒ–ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <section class="job-list-area">
                <div class="job-list-header">
                    <h3>ã‚¸ãƒ§ãƒ–ãƒªã‚¹ãƒˆ</h3>
                    <button class="report-btn" onclick="dashboard.showReport()">ğŸ“Š æœ¬æ—¥ã®ãƒ¬ãƒãƒ¼ãƒˆ</button>
                </div>
                
                <div id="jobListContainer" class="job-list-container">
                    <div class="empty-state">
                        ã¾ã ã‚¸ãƒ§ãƒ–ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br>
                        ä¸Šè¨˜ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
                    </div>
                </div>
            </section>

        </main>

        <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>âš™ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</h3>
                    <button class="modal-close" onclick="dashboard.hideSettings()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="settings-section">
                        <h4>å‹¤å‹™æ™‚é–“è¨­å®š</h4>
                        
                        <div class="form-group">
                            <label>å§‹æ¥­æ™‚åˆ»</label>
                            <input type="time" id="settingWorkStart" value="08:30">
                        </div>
                        
                        <div class="form-group">
                            <label>å®šæ™‚çµ‚æ¥­æ™‚åˆ»</label>
                            <input type="time" id="settingWorkEnd" value="17:00">
                        </div>
                        
                        <div class="form-group">
                            <label>æ®‹æ¥­çµ‚æ¥­æ™‚åˆ»</label>
                            <input type="time" id="settingOvertimeEnd" value="18:00">
                        </div>
                        
                        <div class="form-group">
                            <label>æ˜¼ä¼‘ã¿æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                            <input type="number" id="settingLunchBreak" min="0" step="15" value="60">
                        </div>
                        
                        <div class="form-group">
                            <label>ç‰‡ä»˜ã‘æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                            <input type="number" id="settingCleanupTime" min="0" step="5" value="15">
                        </div>
                        
                        <div class="form-group">
                            <label>ç•°ç¨®ãƒ•ã‚£ãƒ«ãƒ äº¤æ›æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                            <input type="number" id="settingDiffFilmChange" min="0" step="5" value="15">
                        </div>
                    </div>
                    
                    <div class="settings-actions">
                        <button class="btn btn-primary" onclick="dashboard.saveSettings()">è¨­å®šã‚’ä¿å­˜</button>
                        <button class="btn btn-secondary" onclick="dashboard.resetSettings()">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="reportModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ğŸ“Š æœ¬æ—¥ã®ä½œæ¥­ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                    <button class="modal-close" onclick="dashboard.hideReport()">&times;</button>
                </div>
                <div class="modal-body" id="reportContent"></div>
            </div>
        </div>

        <!-- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
        <div id="confirmDialog" class="modal">
            <div class="modal-content modal-sm">
                <div class="modal-body">
                    <p id="confirmMessage"></p>
                    <div class="modal-actions">
                        <button class="btn btn-danger" id="confirmYes">å‰Šé™¤</button>
                        <button class="btn btn-secondary" id="confirmNo">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="script.js"></script>
    <!-- ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆé–‹ç™ºæ™‚ã®ã¿æœ‰åŠ¹åŒ–ï¼‰ -->
    <!-- <script src="test-v3.js"></script> -->
</body>
</html>/* ãƒ©ãƒŸã‚ªãƒšãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ Ver.3.0 - çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä»•æ§˜ */

/* Reset & Variables */
:root {
    --primary-color: #2C3E50;
    --secondary-color: #34495E;
    --accent-color: #3498DB;
    --success-color: #27AE60;
    --warning-color: #F39C12;
    --danger-color: #E74C3C;
    --light-gray: #F8F9FA;
    --medium-gray: #E9ECEF;
    --dark-gray: #6C757D;
    --text-color: #2C3E50;
    --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
    --border-radius: 8px;
    --header-height: 70px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    font-size: 16px;
    line-height: 1.5;
    color: var(--text-color);
}

/* App Container */
.app-container {
    max-width: 480px;
    margin: 0 auto;
    background: #fff;
    min-height: 100vh;
    box-shadow: 0 0 20px rgba(0,0,0,0.15);
    position: relative;
}

/* Header */
.app-header {
    background: var(--primary-color);
    color: white;
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--card-shadow);
    position: sticky;
    top: 0;
    z-index: 100;
    height: var(--header-height);
}

.header-title h1 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 4px;
}

.current-time {
    font-size: 12px;
    opacity: 0.9;
    font-family: 'Courier New', monospace;
}

.header-btn {
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: var(--border-radius);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.header-btn:hover {
    background: rgba(255,255,255,0.3);
}

/* Main Dashboard */
.main-dashboard {
    padding: 16px;
}

/* æœ€çµ‚çµ‚äº†äºˆå®šæ™‚åˆ» */
.finish-time-display {
    margin-bottom: 20px;
}

.finish-time-card {
    background: linear-gradient(135deg, var(--success-color) 0%, #2ECC71 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    box-shadow: var(--card-shadow);
}

.finish-label {
    font-size: 12px;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.finish-time {
    font-size: 32px;
    font-weight: bold;
    font-family: 'Courier New', monospace;
    margin-bottom: 8px;
}

.finish-status {
    font-size: 14px;
    background: rgba(255,255,255,0.2);
    padding: 6px 12px;
    border-radius: 16px;
    display: inline-block;
}

.finish-status.warning {
    background: var(--warning-color);
}

.finish-status.danger {
    background: var(--danger-color);
}

/* Time Display Grid */
.time-display-grid {
    background: white;
    border: 2px solid var(--medium-gray);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--card-shadow);
    display: grid;
    grid-template-columns: 1fr 1.5fr 1fr;
    gap: 12px;
}

/* Operation Area */
.operation-area {
    margin-bottom: 24px;
}

/* Job Input Section */
.job-input-section {
    background: white;
    border: 2px solid var(--medium-gray);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--card-shadow);
}

.job-input-section h3 {
    color: var(--primary-color);
    font-size: 16px;
    margin-bottom: 16px;
    border-bottom: 2px solid var(--accent-color);
    padding-bottom: 8px;
}

.job-input-section h4 {
    color: var(--secondary-color);
    font-size: 14px;
    margin: 16px 0 12px 0;
}

/* Input Mode Selector */
.input-mode-selector {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
    background: var(--light-gray);
    padding: 12px;
    border-radius: var(--border-radius);
}

.radio-option {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-weight: 500;
}

.radio-option input[type="radio"] {
    margin-right: 8px;
    transform: scale(1.2);
}

/* Input Modes */
.input-mode {
    display: none;
    margin-bottom: 20px;
}

.input-mode.active {
    display: block;
}

/* Form Elements */
.form-group {
    margin-bottom: 16px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.form-group label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: var(--secondary-color);
    margin-bottom: 6px;
}

.form-group input {
    width: 100%;
    min-height: 48px;
    padding: 12px 16px;
    font-size: 16px;
    border: 2px solid var(--medium-gray);
    border-radius: var(--border-radius);
    background: white;
    transition: border-color 0.2s ease;
}

.form-group input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.form-group input::placeholder {
    color: var(--dark-gray);
}

/* Buttons */
.btn {
    padding: 12px 20px;
    border: none;
    border-radius: var(--border-radius);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 48px;
}

.btn-sm {
    padding: 8px 16px;
    min-height: 36px;
    font-size: 12px;
}

.btn-primary {
    background: var(--accent-color);
    color: white;
}

.btn-primary:hover {
    background: #2980B9;
}

.btn-secondary {
    background: var(--medium-gray);
    color: var(--text-color);
}

.btn-secondary:hover {
    background: #DEE2E6;
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-success:hover {
    background: #229954;
}

.btn-warning {
    background: var(--warning-color);
    color: white;
}

.btn-warning:hover {
    background: #E67E22;
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: #C0392B;
}

/* Job Add Buttons */
.job-add-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 20px;
}

.btn-current-film {
    background: var(--success-color);
    color: white;
}

.btn-current-film:hover {
    background: #229954;
}

.btn-new-film {
    background: var(--warning-color);
    color: white;
}

.btn-new-film:hover {
    background: #E67E22;
}

/* Time Controls */
.time-controls {
    background: white;
    border: 2px solid var(--medium-gray);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--card-shadow);
}

.time-controls h4 {
    color: var(--primary-color);
    font-size: 14px;
    margin-bottom: 12px;
}

.time-btn-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.time-btn {
    background: var(--accent-color);
    color: white;
    border: none;
    padding: 12px 8px;
    border-radius: var(--border-radius);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 44px;
}

.time-btn:hover {
    background: #2980B9;
}

/* Film Status */
.film-status {
    background: white;
    border: 2px solid var(--medium-gray);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--card-shadow);
}

.film-status h4 {
    color: var(--primary-color);
    font-size: 14px;
    margin-bottom: 12px;
}

.current-film-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.film-remaining {
    font-size: 18px;
    font-weight: bold;
    color: var(--success-color);
}

/* Job List Area */
.job-list-area {
    margin-bottom: 24px;
}

.job-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.job-list-header h3 {
    color: var(--primary-color);
    font-size: 16px;
}

.report-btn {
    background: #9B59B6;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: var(--border-radius);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.report-btn:hover {
    background: #8E44AD;
}

/* Job List Container */
.job-list-container {
    min-height: 120px;
}

.empty-state {
    background: var(--light-gray);
    padding: 40px 20px;
    border-radius: var(--border-radius);
    text-align: center;
    color: var(--dark-gray);
    font-style: italic;
    border: 2px dashed var(--medium-gray);
}

/* Film Session */
.film-session {
    margin-bottom: 16px;
    border: 2px solid var(--medium-gray);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--card-shadow);
}

/* Film Add Button */
.film-add-btn {
    margin-top: 8px;
    margin-left: 16px;
}

/* New Film Button Container */
.new-film-button-container {
    text-align: center;
    padding: 20px;
    margin-top: 16px;
}

.new-film-btn {
    width: 100%;
    max-width: 400px;
    padding: 16px 24px;
    font-size: 16px;
    font-weight: bold;
}

.session-header {
    background: var(--secondary-color);
    color: white;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.session-title {
    font-size: 14px;
    font-weight: 600;
}

.session-status {
    font-size: 12px;
    background: rgba(255,255,255,0.2);
    padding: 4px 8px;
    border-radius: 12px;
}

.session-jobs {
    background: white;
}

.session-jobs.collapsed {
    display: none;
}

/* Job Item */
.job-item {
    padding: 16px;
    border-bottom: 1px solid var(--medium-gray);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.job-item:hover {
    background-color: #F8F9FA;
}

.job-item:last-child {
    border-bottom: none;
}

.job-item.completed {
    background: #F8F9FA;
    opacity: 0.8;
}

.job-info {
    flex: 1;
}

.job-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 4px;
}

.job-details {
    font-size: 12px;
    color: var(--dark-gray);
}

.job-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.job-actions-left {
    display: flex;
    align-items: center;
    margin-right: 12px;
}

.job-actions-right {
    display: flex;
    align-items: center;
    margin-left: 12px;
}

.job-complete-btn {
    background: var(--success-color);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.job-complete-btn:hover {
    background: #229954;
}

.job-complete-btn:disabled {
    background: var(--medium-gray);
    cursor: not-allowed;
}

.job-uncomplete-btn {
    background: var(--warning-color);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.job-uncomplete-btn:hover {
    background: #E67E22;
}

.job-delete-btn {
    background: #E57373;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 36px;
}

.job-delete-btn:hover {
    background: #D32F2F;
}

.job-menu-btn {
    background: none;
    border: none;
    font-size: 16px;
    color: var(--dark-gray);
    cursor: pointer;
    padding: 4px;
}

.job-menu-btn:hover {
    color: var(--primary-color);
}

/* Modals */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 16px;
    display: none;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 400px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.modal-sm .modal-content {
    max-width: 300px;
}

.modal-header {
    background: var(--light-gray);
    padding: 16px 20px;
    border-bottom: 1px solid var(--medium-gray);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    font-size: 16px;
    color: var(--primary-color);
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--dark-gray);
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: var(--medium-gray);
    color: var(--primary-color);
}

.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
}

/* Calculator Specific Styles */
.calc-description {
    color: var(--dark-gray);
    font-size: 14px;
    margin-bottom: 20px;
    text-align: center;
}

.preset-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.calc-result {
    margin-top: 20px;
    padding: 16px;
    background: var(--light-gray);
    border-radius: var(--border-radius);
    text-align: center;
    display: none;
}

.calc-result.active {
    display: block;
}

.calc-result.success {
    background: #D5EDDA;
    color: #155724;
    border: 1px solid #C3E6CB;
}

/* Responsive Design */
@media (max-width: 360px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .job-add-buttons {
        grid-template-columns: 1fr;
    }
    
    .time-btn-grid {
        grid-template-columns: 1fr;
    }
}

/* Animation */
.fade-in {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.slide-up {
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* Loading States */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid transparent;
    border-top: 2px solid var(--accent-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* Focus States for Accessibility */
button:focus,
input:focus {
    outline: 2px solid var(--accent-color);
    outline-offset: 2px;
}// ãƒ©ãƒŸã‚ªãƒšãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ Ver.3.0 - çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä»•æ§˜

class LaminatorDashboard {
    constructor() {
        this.filmSessions = []; // ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
        this.currentFilmSession = null; // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³
        this.extraTime = 0; // æ‰‹å‹•è¿½åŠ æ™‚é–“ï¼ˆåˆ†ï¼‰
        this.defaultFilmCapacity = 500; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚£ãƒ«ãƒ å®¹é‡ï¼ˆmï¼‰
        this.workStarted = false; // æ¥­å‹™é–‹å§‹ãƒ•ãƒ©ã‚°
        this.workStartTime = null; // æ¥­å‹™é–‹å§‹æ™‚åˆ»
        this.targetEndTime = "17:00"; // ç›®æ¨™çµ‚æ¥­æ™‚åˆ»
        this.preparedJob = null; // æº–å‚™ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ï¼ˆè¿½åŠ å…ˆæœªæ±ºå®šï¼‰
        
        // æ™‚é–“è¨­å®š
        this.timeSettings = {
            workStart: "08:30",
            workEnd: "17:00",
            overtimeEnd: "18:00",  // æ®‹æ¥­çµ‚æ¥­æ™‚åˆ»
            lunchBreak: 60,        // åˆ†
            cleanupTime: 15,       // åˆ†
            sameFilmChange: 10,    // åˆ†ï¼ˆåŒç¨®ãƒ•ã‚£ãƒ«ãƒ äº¤æ›ï¼‰
            diffFilmChange: 15     // åˆ†ï¼ˆç•°ç¨®ãƒ•ã‚£ãƒ«ãƒ äº¤æ›ï¼‰
        };

        this.init();
    }

    init() {
        this.loadData();
        this.setupEventListeners();
        this.updateCurrentTime();
        this.updateTimeDisplay();
        this.updateFinishTime();
        this.renderJobList();
        
        // 1ç§’ã”ã¨ã«æ™‚åˆ»æ›´æ–°
        setInterval(() => {
            this.updateCurrentTime();
        }, 1000);
    }

    setupEventListeners() {
        // å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        document.querySelectorAll('input[name="inputMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                this.switchInputMode(e.target.value);
            });
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    }

    switchInputMode(mode) {
        const directMode = document.getElementById('directMode');
        const partsMode = document.getElementById('partsMode');

        if (mode === 'direct') {
            directMode.classList.add('active');
            partsMode.classList.remove('active');
        } else {
            directMode.classList.remove('active');
            partsMode.classList.add('active');
        }
    }

    // æ¥­å‹™é–‹å§‹
    startWork() {
        if (!this.workStarted) {
            this.workStarted = true;
            this.workStartTime = new Date();
            this.updateTimeDisplay();
            this.updateFinishTime();
            this.saveData();
            this.showToast('æ¥­å‹™ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
        } else {
            this.showToast('æ¥­å‹™ã¯æ—¢ã«é–‹å§‹ã•ã‚Œã¦ã„ã¾ã™', 'info');
        }
    }

    // é–‹å§‹æ™‚åˆ»ç·¨é›†
    editStartTime() {
        const currentTimeStr = this.workStarted && this.workStartTime ? 
            this.workStartTime.toTimeString().slice(0, 5) : this.timeSettings.workStart;
        
        const newTime = prompt('é–‹å§‹æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (HH:MMå½¢å¼)', currentTimeStr);
        if (newTime && this.isValidTimeFormat(newTime)) {
            if (!this.workStarted) {
                // æ¥­å‹™æœªé–‹å§‹ã®å ´åˆã¯å³åº§ã«æ¥­å‹™é–‹å§‹
                const today = new Date();
                const [hours, minutes] = newTime.split(':');
                this.workStartTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), parseInt(hours), parseInt(minutes));
                this.workStarted = true;
            } else {
                // æ¥­å‹™é–‹å§‹æ¸ˆã¿ã®å ´åˆã¯æ™‚åˆ»ã‚’ä¿®æ­£
                const [hours, minutes] = newTime.split(':');
                this.workStartTime.setHours(parseInt(hours), parseInt(minutes));
            }
            this.updateTimeDisplay();
            this.updateFinishTime();
            this.saveData();
            this.showToast('é–‹å§‹æ™‚åˆ»ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
        }
    }

    // ç›®æ¨™æ™‚åˆ»ç·¨é›†
    editTargetTime() {
        const currentTarget = this.targetEndTime;
        const isOvertime = currentTarget === this.timeSettings.overtimeEnd;
        
        if (confirm(isOvertime ? 'å®šæ™‚ï¼ˆ17:00ï¼‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã‹ï¼Ÿ' : 'æ®‹æ¥­ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã‹ï¼Ÿ')) {
            this.targetEndTime = isOvertime ? this.timeSettings.workEnd : this.timeSettings.overtimeEnd;
            this.updateTimeDisplay();
            this.showToast(`ç›®æ¨™æ™‚åˆ»ã‚’${this.targetEndTime}ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');
            this.saveData();
        }
    }

    // æ™‚é–“è¡¨ç¤ºæ›´æ–°
    updateTimeDisplay() {
        // é–‹å§‹æ™‚åˆ»è¡¨ç¤º
        const workStartElement = document.getElementById('workStartTime');
        if (this.workStarted && this.workStartTime) {
            workStartElement.textContent = this.workStartTime.toTimeString().slice(0, 5);
            workStartElement.classList.add('active');
        } else {
            workStartElement.textContent = this.timeSettings.workStart;
            workStartElement.classList.remove('active');
        }

        // ç›®æ¨™æ™‚åˆ»è¡¨ç¤º
        const targetElement = document.getElementById('targetEndTime');
        targetElement.textContent = this.targetEndTime;
        targetElement.classList.toggle('overtime', this.targetEndTime === this.timeSettings.overtimeEnd);
    }

    // æ™‚åˆ»å½¢å¼æ¤œè¨¼
    isValidTimeFormat(timeStr) {
        const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
        return timeRegex.test(timeStr);
    }

    // ã‚¸ãƒ§ãƒ–ã‚’æº–å‚™ï¼ˆè¿½åŠ å…ˆã¯å¾Œã§æ±ºå®šï¼‰
    prepareJob() {
        const jobData = this.getJobInputData();
        if (!jobData) return;

        this.preparedJob = jobData;
        this.clearInputs();
        this.renderJobList(); // ãƒœã‚¿ãƒ³è¡¨ç¤ºæ›´æ–°ã®ãŸã‚
        this.showToast(`ã‚¸ãƒ§ãƒ–ã‚’æº–å‚™ã—ã¾ã—ãŸ (${jobData.sheets}æš)ã€‚è¿½åŠ å…ˆã®ãƒ•ã‚£ãƒ«ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`, 'info');
    }

    // æº–å‚™ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ã‚’æŒ‡å®šã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ 
    addPreparedJobToSession(sessionId) {
        if (!this.preparedJob) {
            this.showToast('æº–å‚™ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
            return;
        }

        const session = this.filmSessions.find(s => s.id === sessionId);
        if (!session) {
            this.showToast('æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            return;
        }

        // ãƒ•ã‚£ãƒ«ãƒ æ®‹é‡ãƒã‚§ãƒƒã‚¯
        if (session.filmRemaining < this.preparedJob.usageLength) {
            if (!confirm(`ãƒ•ã‚£ãƒ«ãƒ æ®‹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\nå¿…è¦: ${this.preparedJob.usageLength.toFixed(2)}m\næ®‹é‡: ${session.filmRemaining.toFixed(2)}m\n\nãã‚Œã§ã‚‚è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
        }

        // ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰ã®æ®‹é‡ã‚’æ›´æ–°
        session.jobs.push(this.preparedJob);
        session.filmRemaining = Math.max(0, session.filmRemaining - this.preparedJob.usageLength);
        session.filmUsed += this.preparedJob.usageLength;

        this.saveData();
        this.renderJobList();
        this.updateFinishTime();
        this.updateFilmDisplay();
        
        this.showToast(`ã‚¸ãƒ§ãƒ–ã‚’ãƒ•ã‚£ãƒ«ãƒ ã«è¿½åŠ ã—ã¾ã—ãŸ (${this.preparedJob.sheets}æš)`, 'success');
        this.preparedJob = null; // æº–å‚™ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ã‚’ã‚¯ãƒªã‚¢
    }

    // æº–å‚™ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ã§æ–°ã—ã„ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
    addPreparedJobToNewFilm() {
        if (!this.preparedJob) {
            this.showToast('æº–å‚™ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
            return;
        }

        // æ–°ã—ã„ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
        this.currentFilmSession = this.createNewFilmSession();
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®åˆæœŸæ®‹é‡ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
        if (this.preparedJob.initialFilmRemaining !== null && this.preparedJob.initialFilmRemaining >= 0) {
            this.currentFilmSession.filmCapacity = this.preparedJob.initialFilmRemaining;
            this.currentFilmSession.filmRemaining = this.preparedJob.initialFilmRemaining;
            this.currentFilmSession.filmUsed = 0;
        }
        
        this.filmSessions.push(this.currentFilmSession);

        // ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰ã®æ®‹é‡ã‚’æ›´æ–°
        this.currentFilmSession.jobs.push(this.preparedJob);
        this.currentFilmSession.filmRemaining = Math.max(0, this.currentFilmSession.filmRemaining - this.preparedJob.usageLength);
        this.currentFilmSession.filmUsed += this.preparedJob.usageLength;

        // ãƒ•ã‚£ãƒ«ãƒ äº¤æ›æ™‚é–“ã‚’è¿½åŠ 
        this.extraTime += this.timeSettings.diffFilmChange;

        this.saveData();
        this.renderJobList();
        this.updateFinishTime();
        this.updateFilmDisplay();
        
        this.showToast(`æ–°ã—ã„ãƒ•ã‚£ãƒ«ãƒ ã§ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã—ã¾ã—ãŸ (äº¤æ›æ™‚é–“ +${this.timeSettings.diffFilmChange}åˆ†)`, 'success');
        this.preparedJob = null; // æº–å‚™ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ã‚’ã‚¯ãƒªã‚¢
    }

    // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ãƒ ã§ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ 
    addJobToCurrentFilm() {
        const jobData = this.getJobInputData();
        if (!jobData) return;

        // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆã¯ä½œæˆ
        if (!this.currentFilmSession) {
            this.currentFilmSession = this.createNewFilmSession();
            this.filmSessions.push(this.currentFilmSession);
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰ã®ãƒ•ã‚£ãƒ«ãƒ æ®‹é‡ãƒã‚§ãƒƒã‚¯
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®åˆæœŸæ®‹é‡ãŒã‚ã‚‹å ´åˆã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        if (jobData.initialFilmRemaining !== null && jobData.initialFilmRemaining >= 0) {
            this.currentFilmSession.filmCapacity = jobData.initialFilmRemaining;
            this.currentFilmSession.filmRemaining = jobData.initialFilmRemaining;
            this.currentFilmSession.filmUsed = 0;
        }

        if (this.currentFilmSession.filmRemaining < jobData.usageLength) {
            if (!confirm(`ãƒ•ã‚£ãƒ«ãƒ æ®‹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\nå¿…è¦: ${jobData.usageLength.toFixed(2)}m\næ®‹é‡: ${this.currentFilmSession.filmRemaining.toFixed(2)}m\n\nãã‚Œã§ã‚‚è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
        }

        // ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰ã®æ®‹é‡ã‚’æ›´æ–°
        this.currentFilmSession.jobs.push(jobData);
        this.currentFilmSession.filmRemaining = Math.max(0, this.currentFilmSession.filmRemaining - jobData.usageLength);
        this.currentFilmSession.filmUsed += jobData.usageLength;

        this.saveData();
        this.renderJobList();
        this.updateFinishTime();
        this.updateFilmDisplay();
        this.clearInputs();
        this.showToast(`ã‚¸ãƒ§ãƒ–ã‚’ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ãƒ ã«è¿½åŠ ã—ã¾ã—ãŸ (${jobData.sheets}æš)`, 'success');
    }

    // æ–°ã—ã„ãƒ•ã‚£ãƒ«ãƒ ã§ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ 
    addJobToNewFilm() {
        const jobData = this.getJobInputData();
        if (!jobData) return;

        // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®Œäº†
        if (this.currentFilmSession && this.currentFilmSession.jobs.length > 0) {
            this.currentFilmSession.status = 'completed';
            this.currentFilmSession.endTime = new Date();
        }

        // æ–°ã—ã„ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
        this.currentFilmSession = this.createNewFilmSession();
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®åˆæœŸæ®‹é‡ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
        if (jobData.initialFilmRemaining !== null && jobData.initialFilmRemaining >= 0) {
            this.currentFilmSession.filmCapacity = jobData.initialFilmRemaining;
            this.currentFilmSession.filmRemaining = jobData.initialFilmRemaining;
            this.currentFilmSession.filmUsed = 0;
        }
        
        this.filmSessions.push(this.currentFilmSession);

        // ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰ã®æ®‹é‡ã‚’æ›´æ–°
        this.currentFilmSession.jobs.push(jobData);
        this.currentFilmSession.filmRemaining = Math.max(0, this.currentFilmSession.filmRemaining - jobData.usageLength);
        this.currentFilmSession.filmUsed += jobData.usageLength;

        // ãƒ•ã‚£ãƒ«ãƒ äº¤æ›æ™‚é–“ã‚’è¿½åŠ 
        this.extraTime += this.timeSettings.diffFilmChange;

        this.saveData();
        this.renderJobList();
        this.updateFinishTime();
        this.updateFilmDisplay();
        this.clearInputs();
        this.showToast(`æ–°ã—ã„ãƒ•ã‚£ãƒ«ãƒ ã§ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã—ã¾ã—ãŸ (äº¤æ›æ™‚é–“ +${this.timeSettings.diffFilmChange}åˆ†)`, 'success');
    }

    // ã‚¸ãƒ§ãƒ–å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ãƒ»æ¤œè¨¼
    getJobInputData() {
        const inputMode = document.querySelector('input[name="inputMode"]:checked').value;
        let sheets;

        // æšæ•°è¨ˆç®—
        if (inputMode === 'direct') {
            sheets = parseInt(document.getElementById('directSheets').value);
            if (!sheets || sheets <= 0) {
                alert('ç”Ÿç”£æšæ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return null;
            }
        } else {
            const copies = parseInt(document.getElementById('partsCopies').value);
            const pages = parseInt(document.getElementById('partsPages').value);
            const extra = parseInt(document.getElementById('partsExtra').value) || 0;

            if (!copies || !pages || copies <= 0 || pages <= 0) {
                alert('éƒ¨æ•°ã¨é¢æ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return null;
            }

            // CEILINGé–¢æ•°: å®Ÿç”Ÿç”£æšæ•° = CEILING(éƒ¨æ•° / é¢æ•°) + äºˆå‚™æšæ•°
            sheets = Math.ceil(copies / pages) + extra;
        }

        // å…±é€šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
        const paperLength = parseFloat(document.getElementById('paperLength').value);
        const overlapWidth = parseFloat(document.getElementById('overlapWidth').value);
        const processSpeed = parseFloat(document.getElementById('processSpeed').value);
        const initialFilmRemaining = parseFloat(document.getElementById('initialFilmRemaining').value) || null;

        if (!paperLength || !overlapWidth || !processSpeed || 
            paperLength <= 0 || overlapWidth < 0 || processSpeed <= 0) {
            alert('åŠ å·¥æ¡ä»¶ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
            return null;
        }

        // è¨ˆç®—å®Ÿè¡Œ
        const usageLength = (paperLength - overlapWidth) / 1000; // ãƒ¡ãƒ¼ãƒˆãƒ«å¤‰æ›
        const processingTime = sheets * usageLength / processSpeed; // åˆ†
        
        // å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
        if (usageLength <= 0) {
            alert('ç´™ã®é•·ã•ã¯é‡ã­å¹…ã‚ˆã‚Šå¤§ããã—ã¦ãã ã•ã„');
            return null;
        }
        
        if (processingTime > 480) { // 8æ™‚é–“ä»¥ä¸Šã®å ´åˆè­¦å‘Š
            if (!confirm(`è¨ˆç®—çµæœãŒ ${processingTime.toFixed(1)}åˆ†ï¼ˆ${(processingTime/60).toFixed(1)}æ™‚é–“ï¼‰ã§ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) {
                return null;
            }
        }

        // ã‚¸ãƒ§ãƒ–ãƒ‡ãƒ¼ã‚¿ä½œæˆ
        return {
            id: Date.now().toString(),
            timestamp: new Date(),
            sheets: sheets,
            paperLength: paperLength,
            overlapWidth: overlapWidth,
            processSpeed: processSpeed,
            usageLength: usageLength,
            processingTime: processingTime,
            inputMode: inputMode,
            completed: false,
            initialFilmRemaining: initialFilmRemaining // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®åˆæœŸæ®‹é‡
        };
    }

    // æ–°ã—ã„ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
    createNewFilmSession() {
        const filmCapacity = this.getFilmCapacity();
        return {
            id: Date.now().toString(),
            startTime: new Date(),
            endTime: null,
            jobs: [],
            status: 'active', // active, completed
            filmCapacity: filmCapacity, // æ–°ã—ã„ãƒ•ã‚£ãƒ«ãƒ ã®åˆæœŸå®¹é‡
            filmRemaining: filmCapacity, // ç¾åœ¨ã®æ®‹é‡
            filmUsed: 0 // ä½¿ç”¨æ¸ˆã¿é‡
        };
    }

    // ãƒ•ã‚£ãƒ«ãƒ å®¹é‡ã‚’å–å¾—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    getFilmCapacity() {
        const userInput = prompt('æ–°ã—ã„ãƒ•ã‚£ãƒ«ãƒ ã®å®¹é‡ (m) ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', this.defaultFilmCapacity.toString());
        if (userInput && !isNaN(userInput) && parseFloat(userInput) > 0) {
            return parseFloat(userInput);
        }
        return this.defaultFilmCapacity;
    }

    // ã‚¸ãƒ§ãƒ–ãƒªã‚¹ãƒˆè¡¨ç¤º
    renderJobList() {
        const container = document.getElementById('jobListContainer');
        
        if (this.filmSessions.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    ã¾ã ã‚¸ãƒ§ãƒ–ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br>
                    ä¸Šè¨˜ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
                </div>
            `;
            return;
        }

        // å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        this.updateSessionStatuses();

        // ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é™é †ã§è¡¨ç¤ºï¼ˆæ–°ã—ã„ãƒ•ã‚£ãƒ«ãƒ ãŒä¸Šéƒ¨ï¼‰
        const reversedSessions = [...this.filmSessions].reverse();
        
        const sessionsHtml = reversedSessions.map((session, displayIndex) => {
            const originalIndex = this.filmSessions.length - displayIndex;
            const sessionStatus = this.getSessionStatus(session);
            // å…¨ã‚¸ãƒ§ãƒ–ã®ç·ä½¿ç”¨ãƒ¡ãƒ¼ã‚¿ãƒ¼æ•°ã‚’æ­£ç¢ºã«è¨ˆç®—
            const totalUsed = session.jobs.reduce((total, job) => total + (job.sheets * job.usageLength), 0);
            // æº–å‚™ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ãŒã‚ã‚‹å ´åˆã®ã¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const addJobButton = this.preparedJob ? `
                <button class="btn btn-sm btn-success film-add-btn" onclick="event.stopPropagation(); dashboard.addPreparedJobToSession('${session.id}')">
                    + ã“ã®ãƒ•ã‚£ãƒ«ãƒ ã«ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ 
                </button>
            ` : '';
            return `
            <div class="film-session">
                <div class="session-header" onclick="dashboard.toggleSession('${session.id}')">
                    <div class="session-title">
                        ãƒ•ã‚£ãƒ«ãƒ  ${originalIndex} (${session.jobs.length}ã‚¸ãƒ§ãƒ–)
                        <div class="session-film-info">ä½¿ç”¨: ${totalUsed.toFixed(1)}m / æ®‹ã‚Š: ${session.filmRemaining.toFixed(1)}m</div>
                        ${addJobButton}
                    </div>
                    <div class="session-status ${sessionStatus.status}">
                        ${sessionStatus.label}
                    </div>
                </div>
                <div id="session-${session.id}" class="session-jobs">
                    ${session.jobs.slice().reverse().map(job => `
                        <div class="job-item ${job.completed ? 'completed' : ''}" onclick="dashboard.addFilmRemaining('${session.id}', '${job.id}')">
                            <div class="job-actions-left">
                                <button class="job-delete-btn" onclick="event.stopPropagation(); dashboard.deleteJob('${session.id}', '${job.id}')" title="å‰Šé™¤">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                            <div class="job-info">
                                <div class="job-name">${this.formatTime(job.timestamp)} ã®ã‚¸ãƒ§ãƒ–</div>
                                <div class="job-details">
                                    ${job.sheets}æš / ${job.usageLength.toFixed(2)}m / ${job.processingTime.toFixed(1)}åˆ† / ${(job.sheets * job.usageLength).toFixed(1)}m
                                    ${job.completed ? `<br><strong>å®Œäº†æ™‚åˆ»: ${this.formatTime(job.completedAt)}</strong>` : ''}
                                </div>
                            </div>
                            <div class="job-actions-right">
                                ${job.completed ? `
                                    <button class="job-uncomplete-btn" onclick="event.stopPropagation(); dashboard.uncompleteJob('${session.id}', '${job.id}')">
                                        æœªå®Œäº†ã«æˆ»ã™
                                    </button>
                                ` : `
                                    <button class="job-complete-btn" onclick="event.stopPropagation(); dashboard.completeJob('${session.id}', '${job.id}')">
                                        å®Œäº†
                                    </button>
                                `}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `}).join('');

        // æ–°ã—ã„ãƒ•ã‚£ãƒ«ãƒ ç”¨ãƒœã‚¿ãƒ³ã‚’æœ«å°¾ã«è¿½åŠ ï¼ˆæº–å‚™ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
        const newFilmButton = this.preparedJob ? `
            <div class="new-film-button-container">
                <button class="btn btn-warning new-film-btn" onclick="dashboard.addPreparedJobToNewFilm()">
                    + æ–°ã—ã„ãƒ•ã‚£ãƒ«ãƒ ã§ã‚¸ãƒ§ãƒ–ã‚’é–‹å§‹
                </button>
            </div>
        ` : '';

        container.innerHTML = sessionsHtml + newFilmButton;
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†ï¼šè¦ªãƒ•ã‚£ãƒ«ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã®çŠ¶æ…‹ã‚’å­ã‚¸ãƒ§ãƒ–ã«åŸºã¥ã„ã¦è‡ªå‹•æ›´æ–°
    updateSessionStatuses() {
        this.filmSessions.forEach(session => {
            const completedJobs = session.jobs.filter(job => job.completed);
            const totalJobs = session.jobs.length;
            
            if (totalJobs === 0) {
                session.status = 'active'; // ç©ºã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯é€²è¡Œä¸­
            } else if (completedJobs.length === totalJobs) {
                session.status = 'completed'; // å…¨ã‚¸ãƒ§ãƒ–å®Œäº†
            } else {
                session.status = 'active'; // ä¸€ã¤ã§ã‚‚æœªå®Œäº†ãŒã‚ã‚Œã°é€²è¡Œä¸­
            }
        });
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’å–å¾—ï¼ˆè¡¨ç¤ºç”¨ï¼‰
    getSessionStatus(session) {
        const completedJobs = session.jobs.filter(job => job.completed);
        const totalJobs = session.jobs.length;
        
        if (totalJobs === 0) {
            return { status: 'active', label: 'é€²è¡Œä¸­' };
        } else if (completedJobs.length === totalJobs) {
            return { status: 'completed', label: 'å®Œäº†' };
        } else {
            return { status: 'active', label: 'é€²è¡Œä¸­' };
        }
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
    toggleSession(sessionId) {
        const sessionJobs = document.getElementById(`session-${sessionId}`);
        sessionJobs.classList.toggle('collapsed');
    }

    // ã‚¸ãƒ§ãƒ–å®Œäº†
    completeJob(sessionId, jobId) {
        const session = this.filmSessions.find(s => s.id === sessionId);
        if (!session) {
            console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', sessionId);
            return;
        }

        const job = session.jobs.find(j => j.id === jobId);
        if (!job) {
            console.error('ã‚¸ãƒ§ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', jobId);
            return;
        }

        // ç¢ºå®šçµ‚äº†æ™‚åˆ»ã‚’è¨˜éŒ²
        const completedAt = new Date();
        job.completed = true;
        job.completedAt = completedAt;
        job.actualCompletionTime = completedAt; // å®Ÿéš›ã®å®Œäº†æ™‚åˆ»

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚‚æ›´æ–°
        this.updateSessionStatuses();

        // å…¨ä½“ã®çµ‚äº†æ™‚åˆ»ã‚’å†è¨ˆç®—ï¼ˆå®Œäº†ã—ãŸã‚¸ãƒ§ãƒ–ã¯å®Ÿæ™‚é–“ã‹ã‚‰é™¤å¤–ï¼‰
        this.recalculateFinishTime();

        this.saveData();
        this.renderJobList();
        this.updateFinishTime();
        
        const completedTimeStr = completedAt.toLocaleTimeString('ja-JP', {
            hour: '2-digit',
            minute: '2-digit'
        });
        this.showToast(`ã‚¸ãƒ§ãƒ–ã‚’å®Œäº†ã—ã¾ã—ãŸï¼ˆ${completedTimeStr}ï¼‰`, 'success');
    }

    // ã‚¸ãƒ§ãƒ–æœªå®Œäº†ã«æˆ»ã™
    uncompleteJob(sessionId, jobId) {
        const session = this.filmSessions.find(s => s.id === sessionId);
        if (!session) {
            console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', sessionId);
            return;
        }

        const job = session.jobs.find(j => j.id === jobId);
        if (!job) {
            console.error('ã‚¸ãƒ§ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', jobId);
            return;
        }

        // å®Œäº†çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        job.completed = false;
        job.completedAt = null;
        job.actualCompletionTime = null;

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚‚æ›´æ–°ï¼ˆè¦ªãƒ–ãƒ­ãƒƒã‚¯ãŒè‡ªå‹•çš„ã«ã€Œé€²è¡Œä¸­ã€ã«æˆ»ã‚‹ï¼‰
        this.updateSessionStatuses();

        // å…¨ä½“ã®çµ‚äº†æ™‚åˆ»ã‚’å†è¨ˆç®—
        this.recalculateFinishTime();

        this.saveData();
        this.renderJobList();
        this.updateFinishTime();
        
        this.showToast('ã‚¸ãƒ§ãƒ–ã‚’æœªå®Œäº†ã«æˆ»ã—ã¾ã—ãŸ', 'info');
    }

    // ãƒ•ã‚£ãƒ«ãƒ æ®‹é‡è¿½åŠ æ©Ÿèƒ½
    addFilmRemaining(sessionId, jobId) {
        const session = this.filmSessions.find(s => s.id === sessionId);
        if (!session) return;

        const job = session.jobs.find(j => j.id === jobId);
        if (!job) return;

        const currentRemaining = session.filmRemaining;
        const adjustmentAmount = prompt(
            `ãƒ•ã‚£ãƒ«ãƒ æ®‹é‡ã‚’èª¿æ•´ã—ã¦ãã ã•ã„:\n\n` +
            `ç¾åœ¨ã®æ®‹é‡: ${currentRemaining.toFixed(1)}m\n` +
            `ã“ã®ã‚¸ãƒ§ãƒ–ã®å¿…è¦é‡: ${job.usageLength.toFixed(2)}m\n\n` +
            `èª¿æ•´é‡ (æ­£æ•°ã§è¿½åŠ ã€è² æ•°ã§æ¸›ç®—):`,
            ''
        );
        
        if (adjustmentAmount && !isNaN(adjustmentAmount)) {
            const adjustAmount = parseFloat(adjustmentAmount);
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ•ã‚£ãƒ«ãƒ æ®‹é‡ã¨å®¹é‡ã‚’èª¿æ•´
            session.filmRemaining += adjustAmount;
            session.filmCapacity += adjustAmount;
            
            // æ®‹é‡ãŒè² ã«ãªã‚‰ãªã„ã‚ˆã†ã«åˆ¶é™
            if (session.filmRemaining < 0) {
                session.filmRemaining = 0;
            }
            if (session.filmCapacity < 0) {
                session.filmCapacity = 0;
            }
            
            this.saveData();
            this.renderJobList();
            this.updateFilmDisplay();
            
            const actionText = adjustAmount >= 0 ? `è¿½åŠ ` : `æ¸›ç®—`;
            this.showToast(`ãƒ•ã‚£ãƒ«ãƒ æ®‹é‡ã‚’ ${Math.abs(adjustAmount)}m ${actionText}ã—ã¾ã—ãŸ`, 'success');
        }
    }

    // çµ‚äº†æ™‚åˆ»å†è¨ˆç®—ï¼ˆå®Œäº†ã‚¸ãƒ§ãƒ–ã‚’è€ƒæ…®ï¼‰
    recalculateFinishTime() {
        if (!this.workStarted) return;

        // æœªå®Œäº†ã‚¸ãƒ§ãƒ–ã®ã¿ã®åˆè¨ˆæ™‚é–“ã‚’è¨ˆç®—
        const allJobs = this.filmSessions.flatMap(session => session.jobs);
        const incompleteJobs = allJobs.filter(job => !job.completed);
        const totalProcessingTime = incompleteJobs.reduce((total, job) => total + job.processingTime, 0);
        
        // å®Œäº†ã‚¸ãƒ§ãƒ–ã®å®Ÿéš›ã®æ™‚é–“æ¶ˆè²»ã‚’è€ƒæ…®ï¼ˆç¾åœ¨æ™‚åˆ»åŸºæº–ï¼‰
        const now = new Date();
        const elapsedTime = (now - this.workStartTime) / 60000; // åˆ†
        
        // æ®‹ã‚Šæ™‚é–“ = æœªå®Œäº†ã‚¸ãƒ§ãƒ–ã®æ™‚é–“ + è¿½åŠ æ™‚é–“ + ç‰‡ä»˜ã‘æ™‚é–“
        const remainingTime = totalProcessingTime + this.extraTime + this.timeSettings.cleanupTime;
        
        // æ–°ã—ã„çµ‚äº†äºˆå®šæ™‚åˆ» = ç¾åœ¨æ™‚åˆ» + æ®‹ã‚Šæ™‚é–“
        this.estimatedFinishTime = new Date(now.getTime() + remainingTime * 60000);
        
        return this.estimatedFinishTime;
    }

    // ã‚¸ãƒ§ãƒ–å‰Šé™¤
    deleteJob(sessionId, jobId) {
        if (!confirm('ã“ã®ã‚¸ãƒ§ãƒ–ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

        const session = this.filmSessions.find(s => s.id === sessionId);
        if (!session) return;

        const jobIndex = session.jobs.findIndex(j => j.id === jobId);
        if (jobIndex === -1) return;

        const job = session.jobs[jobIndex];
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰ã®ãƒ•ã‚£ãƒ«ãƒ ä½¿ç”¨é‡ã‚’æˆ»ã™
        if (!job.completed) {
            session.filmRemaining += job.usageLength;
            session.filmUsed = Math.max(0, session.filmUsed - job.usageLength);
        }

        session.jobs.splice(jobIndex, 1);

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç©ºã«ãªã£ãŸå ´åˆã¯å‰Šé™¤
        if (session.jobs.length === 0) {
            const sessionIndex = this.filmSessions.findIndex(s => s.id === sessionId);
            this.filmSessions.splice(sessionIndex, 1);
            
            // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
            if (this.currentFilmSession && this.currentFilmSession.id === sessionId) {
                this.currentFilmSession = this.filmSessions.find(s => s.status === 'active') || null;
            }
        }

        this.saveData();
        this.renderJobList();
        this.updateFinishTime();
        this.showToast('ã‚¸ãƒ§ãƒ–ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    }

    // æ‰‹å‹•æ™‚é–“è¿½åŠ 
    addManualTime() {
        const minutes = prompt('è¿½åŠ ã™ã‚‹æ™‚é–“ã‚’åˆ†ã§å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (minutes && !isNaN(minutes) && parseInt(minutes) > 0) {
            this.extraTime += parseInt(minutes);
            this.saveData();
            this.updateFinishTime();
            this.showToast(`${minutes}åˆ†ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
        }
    }

    // æ˜¼ä¼‘ã¿è¿½åŠ 
    addLunchBreak() {
        this.extraTime += this.timeSettings.lunchBreak;
        this.saveData();
        this.updateFinishTime();
        this.showToast(`æ˜¼ä¼‘ã¿ ${this.timeSettings.lunchBreak}åˆ†ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
    }

    // äº¤æ›æ™‚é–“è¿½åŠ 
    addExchangeTime() {
        const exchangeTime = this.timeSettings.diffFilmChange;
        this.extraTime += exchangeTime;
        this.saveData();
        this.updateFinishTime();
        this.showToast(`ãƒ•ã‚£ãƒ«ãƒ äº¤æ›æ™‚é–“ ${exchangeTime}åˆ†ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
    }

    // ãƒ•ã‚£ãƒ«ãƒ æ®‹é‡è¨­å®š
    setFilmAmount() {
        if (!this.currentFilmSession) {
            this.showToast('å…ˆã«ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã—ã¦ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 'warning');
            return;
        }

        const currentRemaining = this.currentFilmSession.filmRemaining;
        const amount = prompt('ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ãƒ æ®‹é‡ (m) ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', currentRemaining.toString());
        if (amount && !isNaN(amount) && parseFloat(amount) >= 0) {
            this.currentFilmSession.filmRemaining = parseFloat(amount);
            // ä½¿ç”¨é‡ã‚‚å†è¨ˆç®—ï¼ˆå®¹é‡ - æ®‹é‡ = ä½¿ç”¨é‡ï¼‰
            this.currentFilmSession.filmUsed = this.currentFilmSession.filmCapacity - parseFloat(amount);
            this.updateFilmDisplay();
            this.saveData();
            this.showToast(`ãƒ•ã‚£ãƒ«ãƒ æ®‹é‡ã‚’ ${amount}m ã«è¨­å®šã—ã¾ã—ãŸ`, 'success');
        }
    }

    // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    showSettings() {
        this.loadSettingsToUI();
        const modal = document.getElementById('settingsModal');
        modal.classList.add('active');
    }

    // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
    hideSettings() {
        const modal = document.getElementById('settingsModal');
        modal.classList.remove('active');
    }

    // è¨­å®šã‚’UIã«èª­ã¿è¾¼ã¿
    loadSettingsToUI() {
        document.getElementById('settingWorkStart').value = this.timeSettings.workStart;
        document.getElementById('settingWorkEnd').value = this.timeSettings.workEnd;
        document.getElementById('settingOvertimeEnd').value = this.timeSettings.overtimeEnd;
        document.getElementById('settingLunchBreak').value = this.timeSettings.lunchBreak;
        document.getElementById('settingCleanupTime').value = this.timeSettings.cleanupTime;
        document.getElementById('settingDiffFilmChange').value = this.timeSettings.diffFilmChange;
    }

    // è¨­å®šã‚’ä¿å­˜
    saveSettings() {
        const newSettings = {
            workStart: document.getElementById('settingWorkStart').value,
            workEnd: document.getElementById('settingWorkEnd').value,
            overtimeEnd: document.getElementById('settingOvertimeEnd').value,
            lunchBreak: parseInt(document.getElementById('settingLunchBreak').value),
            cleanupTime: parseInt(document.getElementById('settingCleanupTime').value),
            sameFilmChange: this.timeSettings.sameFilmChange, // ç¶­æŒ
            diffFilmChange: parseInt(document.getElementById('settingDiffFilmChange').value)
        };

        // å…¥åŠ›å€¤æ¤œè¨¼
        if (!newSettings.workStart || !newSettings.workEnd || !newSettings.overtimeEnd ||
            newSettings.lunchBreak < 0 || newSettings.cleanupTime < 0 || newSettings.diffFilmChange < 0) {
            alert('è¨­å®šå€¤ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        this.timeSettings = newSettings;
        this.saveData();
        this.updateFinishTime(); // çµ‚äº†æ™‚åˆ»ã‚’å†è¨ˆç®—
        this.hideSettings();
        this.showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
    }

    // è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
    resetSettings() {
        if (confirm('è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
            this.timeSettings = {
                workStart: "08:30",
                workEnd: "17:00",
                overtimeEnd: "18:00",
                lunchBreak: 60,
                cleanupTime: 15,
                sameFilmChange: 10,
                diffFilmChange: 15
            };
            this.loadSettingsToUI();
            this.saveData();
            this.updateFinishTime();
            this.showToast('è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ', 'success');
        }
    }

    // ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
    showReport() {
        const allJobs = this.filmSessions.flatMap(session => session.jobs);
        const totalSheets = allJobs.reduce((total, job) => total + job.sheets, 0);
        const totalUsage = allJobs.reduce((total, job) => total + job.usageLength, 0);
        const totalProcessingTime = allJobs.reduce((total, job) => total + job.processingTime, 0);
        const completedJobs = allJobs.filter(job => job.completed).length;
        
        const reportContent = `
            <div class="report-summary">
                <h3>æœ¬æ—¥ã®ã‚µãƒãƒªãƒ¼</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</div>
                        <div class="summary-value">${this.filmSessions.length}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">åˆè¨ˆã‚¸ãƒ§ãƒ–æ•°</div>
                        <div class="summary-value">${allJobs.length}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">å®Œäº†ã‚¸ãƒ§ãƒ–æ•°</div>
                        <div class="summary-value">${completedJobs}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">åˆè¨ˆç”Ÿç”£æšæ•°</div>
                        <div class="summary-value">${totalSheets}æš</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">åˆè¨ˆä½¿ç”¨ãƒ¡ãƒ¼ã‚¿ãƒ¼</div>
                        <div class="summary-value">${totalUsage.toFixed(2)}m</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ç”Ÿç”£æ™‚é–“</div>
                        <div class="summary-value">${totalProcessingTime.toFixed(1)}åˆ†</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">æ‰‹å‹•è¿½åŠ æ™‚é–“</div>
                        <div class="summary-value">${this.extraTime}åˆ†</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ç¾åœ¨ãƒ•ã‚£ãƒ«ãƒ æ®‹é‡</div>
                        <div class="summary-value">${this.currentFilmSession ? this.currentFilmSession.filmRemaining.toFixed(1) : '0.0'}m</div>
                    </div>
                </div>
            </div>
            
            <div class="report-history">
                <h3>ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´</h3>
                <div class="history-list">
                    ${this.filmSessions.map((session, index) => `
                        <div class="history-item">
                            <div class="history-header">
                                <span>ãƒ•ã‚£ãƒ«ãƒ  ${index + 1}</span>
                                <span>${session.status === 'completed' ? 'å®Œäº†' : 'é€²è¡Œä¸­'}</span>
                            </div>
                            <div class="history-details">
                                ${session.jobs.length}ã‚¸ãƒ§ãƒ– / ${session.jobs.reduce((sum, job) => sum + job.usageLength, 0).toFixed(2)}m / ${session.jobs.reduce((sum, job) => sum + job.processingTime, 0).toFixed(1)}åˆ†
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        document.getElementById('reportContent').innerHTML = reportContent;
        document.getElementById('reportModal').classList.add('active');
    }

    // ãƒ¬ãƒãƒ¼ãƒˆéè¡¨ç¤º
    hideReport() {
        document.getElementById('reportModal').classList.remove('active');
    }

    // ç¾åœ¨æ™‚åˆ»æ›´æ–°
    updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('ja-JP', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('currentTime').textContent = timeString;
    }

    // çµ‚äº†æ™‚åˆ»æ›´æ–°
    updateFinishTime() {
        if (!this.workStarted) {
            document.getElementById('finalFinishTime').textContent = '--:--';
            document.getElementById('finishStatus').textContent = 'æ¥­å‹™é–‹å§‹å‰';
            return;
        }

        const allJobs = this.filmSessions.flatMap(session => session.jobs);
        const totalProcessingTime = allJobs.reduce((total, job) => total + job.processingTime, 0);
        const totalTime = totalProcessingTime + this.extraTime + this.timeSettings.cleanupTime;
        
        // é–‹å§‹æ™‚åˆ»ã‹ã‚‰çµ‚äº†æ™‚åˆ»ã‚’è¨ˆç®—
        const finishTime = new Date(this.workStartTime.getTime() + totalTime * 60000);
        
        const finishTimeString = finishTime.toLocaleTimeString('ja-JP', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        document.getElementById('finalFinishTime').textContent = finishTimeString;
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        this.updateFinishStatus(finishTime);
    }

    // çµ‚äº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    updateFinishStatus(finishTime) {
        const statusElement = document.getElementById('finishStatus');
        const now = new Date();
        const targetTime = this.parseTime(this.targetEndTime);
        const warningTime = this.parseTime('16:45');
        
        if (finishTime > targetTime) {
            const overMinutes = Math.floor((finishTime - targetTime) / 60000);
            statusElement.textContent = `ç›®æ¨™è¶…é +${overMinutes}åˆ†`;
            statusElement.className = 'time-status danger';
        } else if (finishTime > warningTime) {
            const remainingMinutes = Math.floor((targetTime - finishTime) / 60000);
            statusElement.textContent = `ç›®æ¨™ã¾ã§${remainingMinutes}åˆ†`;
            statusElement.className = 'time-status warning';
        } else {
            statusElement.textContent = 'ç›®æ¨™æ™‚åˆ»å†…ã§çµ‚äº†äºˆå®š';
            statusElement.className = 'time-status success';
        }
    }

    // ãƒ•ã‚£ãƒ«ãƒ æ®‹é‡è¡¨ç¤ºæ›´æ–°
    updateFilmDisplay() {
        const filmRemaining = this.currentFilmSession ? this.currentFilmSession.filmRemaining : 0;
        const filmRemainingElement = document.getElementById('currentFilmRemaining');
        if (filmRemainingElement) {
            filmRemainingElement.textContent = filmRemaining.toFixed(1);
        }
        // ãƒ•ã‚£ãƒ«ãƒ æ®‹é‡è¡¨ç¤ºè¦ç´ ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
    }

    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¯ãƒªã‚¢
    clearInputs() {
        document.getElementById('directSheets').value = '';
        document.getElementById('partsCopies').value = '';
        document.getElementById('partsPages').value = '';
        document.getElementById('partsExtra').value = '0';
        document.getElementById('paperLength').value = '';
        document.getElementById('overlapWidth').value = '';
        document.getElementById('processSpeed').value = '';
        document.getElementById('initialFilmRemaining').value = '';
    }

    // æ™‚åˆ»ãƒ‘ãƒ¼ã‚¹
    parseTime(timeString) {
        const [hours, minutes] = timeString.split(':').map(Number);
        const date = new Date();
        date.setHours(hours, minutes, 0, 0);
        return date;
    }

    // æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    formatTime(date) {
        return date.toLocaleTimeString('ja-JP', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    saveData() {
        const data = {
            date: new Date().toDateString(),
            filmSessions: this.filmSessions,
            currentFilmSessionId: this.currentFilmSession ? this.currentFilmSession.id : null,
            extraTime: this.extraTime,
            workStarted: this.workStarted,
            workStartTime: this.workStartTime,
            targetEndTime: this.targetEndTime,
            timeSettings: this.timeSettings
        };
        
        localStorage.setItem('laminator_dashboard_v3', JSON.stringify(data));
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    loadData() {
        try {
            const rawData = localStorage.getItem('laminator_dashboard_v3');
            const data = rawData ? JSON.parse(rawData) : {};
            const today = new Date().toDateString();
            
            if (data.date === today && data.filmSessions) {
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
                this.filmSessions = Array.isArray(data.filmSessions) ? data.filmSessions : [];
                this.extraTime = Number(data.extraTime) || 0;
                this.workStarted = Boolean(data.workStarted);
                this.workStartTime = data.workStartTime ? new Date(data.workStartTime) : null;
                this.targetEndTime = data.targetEndTime || "17:00";
                
                // è¨­å®šã‚‚å¾©å…ƒ
                if (data.timeSettings && typeof data.timeSettings === 'object') {
                    this.timeSettings = { ...this.timeSettings, ...data.timeSettings };
                }
                
                // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¾©å…ƒ
                if (data.currentFilmSessionId && this.filmSessions.length > 0) {
                    this.currentFilmSession = this.filmSessions.find(s => s.id === data.currentFilmSessionId) || null;
                }
                
                console.log('ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«å¾©å…ƒã—ã¾ã—ãŸ:', this.filmSessions.length + 'å€‹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³');
            } else {
                // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸå ´åˆã¾ãŸã¯åˆå›èµ·å‹•æ™‚ã¯ãƒªã‚»ãƒƒãƒˆ
                this.initDefaultData();
                
                // è¨­å®šã®ã¿å¼•ãç¶™ã
                if (data.timeSettings && typeof data.timeSettings === 'object') {
                    this.timeSettings = { ...this.timeSettings, ...data.timeSettings };
                }
                
                if (data.date) {
                    this.showToast('æ–°ã—ã„æ—¥ã®ä½œæ¥­ã‚’é–‹å§‹ã—ã¾ã™', 'info');
                } else {
                    console.log('åˆå›èµ·å‹• - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã§é–‹å§‹');
                }
            }
            
            // åˆæœŸè¡¨ç¤ºæ›´æ–°
            this.updateFilmDisplay();
            
        } catch (error) {
            console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
            console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸlocalStorageãƒ‡ãƒ¼ã‚¿:', localStorage.getItem('laminator_dashboard_v3'));
            this.showToast('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆæœŸçŠ¶æ…‹ã§é–‹å§‹ã—ã¾ã™ã€‚', 'error');
            this.initDefaultData();
        }
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
    initDefaultData() {
        this.filmSessions = [];
        this.currentFilmSession = null;
        this.extraTime = 0;
        this.workStarted = false;
        this.workStartTime = null;
    }

    // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
    showToast(message, type = 'info') {
        // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¹ãƒˆã‚’å‰Šé™¤
        const existingToast = document.querySelector('.toast-notification');
        if (existingToast) {
            existingToast.remove();
        }

        // ãƒˆãƒ¼ã‚¹ãƒˆè¦ç´ ã‚’ä½œæˆ
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        toast.textContent = message;
        
        // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
        Object.assign(toast.style, {
            position: 'fixed',
            bottom: '20px',
            left: '50%',
            transform: 'translateX(-50%) translateY(100px)',
            background: this.getToastColor(type),
            color: 'white',
            padding: '12px 20px',
            borderRadius: '8px',
            fontSize: '14px',
            fontWeight: 'bold',
            boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
            zIndex: '10000',
            opacity: '0',
            transition: 'all 0.3s ease'
        });

        document.body.appendChild(toast);

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒˆãƒ¼ã‚¹ãƒˆã‚’è¡¨ç¤º
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateX(-50%) translateY(0)';
        }, 50);

        // 3ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã¦å‰Šé™¤
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(-50%) translateY(100px)';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }

    getToastColor(type) {
        const colors = {
            success: '#27AE60',
            error: '#E74C3C',
            warning: '#F39C12',
            info: '#3498DB'
        };
        return colors[type] || colors.info;
    }
}

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
let dashboard;

document.addEventListener('DOMContentLoaded', () => {
    dashboard = new LaminatorDashboard();
    
    // PWAå¯¾å¿œ
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('SW registered: ', registration);
                })
                .catch(registrationError => {
                    console.log('SW registration failed: ', registrationError);
                });
        });
    }
});
name: Build Laminator Dashboard PWA to APK (Capacitor 7 + API 35)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Node.js 20 LTS
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Accept Android SDK Licenses
        run: |
          echo "üîë Accepting Android SDK licenses automatically..."
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses
        
      - name: Update Android SDK to API 35 (Capacitor 7 Compatible)
        run: |
          set -e
          echo "üì± Installing Android SDK API 35 for Capacitor 7..."
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-35" "build-tools;35.0.0"
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-34" "build-tools;34.0.0"
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --update
          echo "‚úÖ Android SDK updated to API 35 successfully"
        
      - name: Install Dependencies
        run: |
          echo "üì¶ Installing package.json dependencies..."
          npm install
        
      - name: Prepare Web Assets
        run: |
          echo "üìÇ Preparing web assets for Capacitor 7..."
          sudo apt-get update && sudo apt-get install -y rsync
          mkdir -p www
          rsync -av --exclude='.git*' --exclude='.github' --exclude='node_modules' --exclude='android' ./ www/
          echo "‚úÖ Web assets prepared"
          
      - name: Initialize Capacitor 7 with API 35 Configuration
        run: |
          echo "‚ö° Initializing Capacitor 7 with Android API 35..."
          cat > capacitor.config.ts << 'EOF'
          import { CapacitorConfig } from '@capacitor/cli';
          const config: CapacitorConfig = {
            appId: 'com.bochang.laminator',
            appName: '„É©„Éü„Ç™„Éö„Éª„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ',
            webDir: 'www',
            bundledWebRuntime: false,
            android: {
              allowMixedContent: true,
              minSdkVersion: 23,
              compileSdkVersion: 35,
              targetSdkVersion: 35,
            },
          };
          export default config;
          EOF
          
          echo "üîß Adding Android platform with Capacitor 7..."
          npx cap add android
          
          echo "üìã Configuring variables.gradle for Capacitor 7 + API 35..."
          cat > android/variables.gradle << 'EOF'
          ext {
              minSdkVersion = 23
              compileSdkVersion = 35
              targetSdkVersion = 35
              androidxActivityVersion = '1.9.2'
              androidxAppCompatVersion = '1.7.0'
              androidxCoordinatorLayoutVersion = '1.2.0'
              androidxCoreVersion = '1.15.0'
              androidxFragmentVersion = '1.8.4'
              coreSplashScreenVersion = '1.0.1'
              androidxWebkitVersion = '1.12.1'
              junitVersion = '4.13.2'
              androidxJunitVersion = '1.2.1'
              androidxEspressoCoreVersion = '3.6.1'
              cordovaAndroidVersion = '10.1.1'
          }
          EOF
          echo "‚úÖ Capacitor 7 initialization complete"
          
      - name: Copy Web Assets to Android
        run: |
          echo "üì± Copying web assets to Android platform..."
          npx cap copy android
          echo "‚úÖ Assets copied successfully"
          
      - name: Fix Plugin Repository with settings.gradle & AGP 8.5.2
        run: |
          echo "üîß Emergency downgrade to AGP 8.5.2 for GitHub Actions compatibility..."
          cd android
          
          # Create settings.gradle with pluginManagement (Correct Plugin Repository Fix)
          cat > settings.gradle << 'EOF'
          pluginManagement {
              repositories {
                  gradlePluginPortal()   // Essential for plugin resolution  
                  google()
                  mavenCentral()
              }
          }
          EOF
          
          # Update project-level build.gradle (without pluginManagement)
          cat > build.gradle << 'EOF'
          // Top-level build file where you can add configuration options common to all sub-projects/modules.

          plugins {
              id 'com.android.application' version '8.5.2' apply false
              id 'com.android.library' version '8.5.2' apply false
              id 'com.google.gms.google-services' version '4.4.2' apply false
          }

          repositories {
              google()
              mavenCentral()
          }

          task clean(type: Delete) {
              delete rootProject.buildDir
          }
          EOF
          echo "‚úÖ Android Gradle Plugin downgraded to 8.5.2 (GitHub Actions Compatible)"
          
      - name: Setup Android Keystore
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "üì± Using production keystore from GitHub Secrets"
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore
            echo "KEYSTORE_FILE=release.keystore" >> $GITHUB_ENV
            echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
            echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
            echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
            echo "‚úÖ Production keystore created"
          else
            echo "‚ö†Ô∏è KEYSTORE_BASE64 secret not found. App will be unsigned."
          fi

      - name: Configure Build for Capacitor 7 + API 35 Signing
        if: env.KEYSTORE_B64_DATA != ''
        env:
          KEYSTORE_B64_DATA: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_FILE: release.keystore
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          set -e -o pipefail

          echo "üîë Configuring Capacitor 7 + API 35 signing..."
          cd android
          echo -n "$KEYSTORE_B64_DATA" | base64 --decode > app/$KEYSTORE_FILE
          echo "‚úÖ Keystore file created at android/app/$KEYSTORE_FILE"

          echo "üîß Creating unified Capacitor 7 + API 35 build.gradle (ÈáçË§áandroid{}„Éñ„É≠„ÉÉ„ÇØËß£Ê±∫)..."
          cat > app/build.gradle << 'EOF'
          plugins {
              id 'com.android.application'
          }

          android {
              compileSdkVersion 35
              namespace "com.bochang.laminator"
              
              defaultConfig {
                  applicationId "com.bochang.laminator"
                  minSdkVersion 23
                  targetSdkVersion 35
                  versionCode 1
                  versionName "2.16"
                  testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
              }
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              
              signingConfigs {
                  release {
                      storeFile file(System.getenv("KEYSTORE_FILE"))
                      storePassword System.getenv("KEYSTORE_PASSWORD")
                      keyAlias System.getenv("KEY_ALIAS")
                      keyPassword System.getenv("KEY_PASSWORD")
                  }
              }
              
              buildTypes {
                  release {
                      minifyEnabled true
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                      signingConfig signingConfigs.release
                  }
              }
          }

          dependencies {
              implementation 'androidx.appcompat:appcompat:1.7.0'
              implementation 'androidx.core:core:1.15.0'
              implementation 'com.capacitor:core:7.0.0'
              testImplementation 'junit:junit:4.13.2'
              androidTestImplementation 'androidx.test.ext:junit:1.2.1'
              androidTestImplementation 'androidx.test.espresso:espresso-core:3.6.1'
          }
          EOF
          echo "‚úÖ Capacitor 7 + API 35 unified build configuration complete"

      - name: Build Android APK with Capacitor 7
        run: |
          echo "üèóÔ∏è Starting Capacitor 7 + API 35 Android APK build..."
          cd android
          
          echo "üßπ Cleaning previous builds..."
          ./gradlew clean
          
          echo "üìã Displaying Gradle version and configuration..."
          ./gradlew --version
          
          echo "üî® Building release APK with enhanced error handling..."
          ./gradlew assembleRelease --stacktrace --info --debug > build.log 2>&1 || {
            echo "‚ùå Build failed. Analyzing build log comprehensively..."
            echo "üîç FIRST 30 LINES (Root Cause Detection):"
            head -30 build.log
            echo ""
            echo "üîç ERROR/FAILURE SECTIONS (Specific Issues):"
            grep -A 3 -B 3 -i "FAILURE\|BUILD FAILED\|Error\|Exception" build.log | head -30
            echo ""
            echo "üîç LAST 30 LINES (Stack Trace End):"
            tail -30 build.log
            exit 1
          }
          
          echo "‚úÖ Capacitor 7 + API 35 APK build completed successfully"

      - name: Verify and Package APK
        run: |
          echo "üîç Searching for generated APK files..."
          find android -name "*.apk" -type f
          
          APK_PATH=$(find android/app/build/outputs/apk/release -name "*.apk" | head -1)
          if [ -n "$APK_PATH" ]; then
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            NEW_NAME="laminator-dashboard-capacitor7-v2.16-${TIMESTAMP}.apk"
            echo "‚úÖ Found APK: $APK_PATH"
            echo "üì¶ Packaging as: $NEW_NAME"
            cp "$APK_PATH" "$NEW_NAME"
            echo "APK_FILENAME=$NEW_NAME" >> $GITHUB_ENV
            
            echo "üìä APK Information:"
            ls -lh "$NEW_NAME"
            echo "üéâ Capacitor 7 + API 35 APK successfully created and packaged"
          else
            echo "‚ùå APK not found in expected location"
            echo "üìÇ Full directory structure:"
            find android -type f -name "*.apk"
            echo "üìÇ Build outputs structure:"
            find android/app/build -name "*.apk" 2>/dev/null || echo "No APK found in build outputs"
            exit 1
          fi
          
      - name: Upload Capacitor 7 APK to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.APK_FILENAME }}
          tag_name: v2.16-capacitor7-build-${{ github.run_number }}
          name: "üöÄ Laminator Dashboard v2.16 Capacitor 7 Build ${{ github.run_number }}"
          body: |
            # üéõÔ∏è „É©„Éü„Ç™„Éö„Éª„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ v2.16 (Capacitor 7 + API 35)
            
            **üöÄ VANILLA_ICE_CREAM ÂïèÈ°åÂÆåÂÖ®Ëß£Ê±∫Áâà** - Capacitor 7 + Android API 35 + AGP 8.5.2
            
            ## üì• „Ç§„É≥„Çπ„Éà„Éº„É´ÊñπÊ≥ï
            1. ‚¨áÔ∏è APK„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            2. üîì AndroidÁ´ØÊú´„Åß„Äå‰∏çÊòé„Å™„ÇΩ„Éº„Çπ„Åã„Çâ„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´„Äç„ÇíË®±ÂèØ
            3. üì± APK„Éï„Ç°„Ç§„É´„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Ç§„É≥„Çπ„Éà„Éº„É´
            
            ## ‚ú® Ver.2.16 ÂÖ®Ê©üËÉΩ
            - ‚è∞ **ÊôÇÈñìË®àÁÆóÊ©ü** - ÁîüÁî£ÊôÇÈñì„ÉªÁµÇ‰∫ÜÊôÇÂàª‰∫àÊ∏¨
            - üéûÔ∏è **„Éï„Ç£„É´„É†„Çª„ÉÉ„Ç∑„Éß„É≥ÁÆ°ÁêÜ** - Ê∂àË≤ªÈáè„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥  
            - üìã **„Ç∏„Éß„ÉñÁÆ°ÁêÜ** - „É™„Ç¢„É´„Çø„Ç§„É†ÈÄ≤ÊçóËøΩË∑°
            - üìä **„É¨„Éù„Éº„ÉàÁîüÊàê** - ‰ΩúÊ•≠ÂäπÁéáÂàÜÊûê
            - üåê **PWAÂØæÂøú** - „Ç™„Éï„É©„Ç§„É≥Âãï‰Ωú„Éª„Éõ„Éº„É†ÁîªÈù¢ËøΩÂä†
            - üîÑ **„Ç∑„Éº„É†„É¨„ÇπÊõ¥Êñ∞** - ÁΩ≤Âêç‰∏ÄË≤´ÊÄß„Å´„Çà„Çã‰∏äÊõ∏„Åç„Ç§„É≥„Çπ„Éà„Éº„É´
            
            ## üîß ÊäÄË°ì‰ªïÊßò
            - **„Éì„É´„ÉâÁí∞Â¢É**: Ubuntu Latest + Node.js 20 LTS + Java 17
            - **„Éï„É¨„Éº„É†„ÉØ„Éº„ÇØ**: Capacitor 7.0.0 + Android API 35
            - **„Éì„É´„Éâ„ÉÑ„Éº„É´**: Android Gradle Plugin 8.5.2 + Gradle 8.11
            - **ÁΩ≤ÂêçÊñπÂºè**: Ëá™Âãï„Ç≠„Éº„Çπ„Éà„Ç¢ÁÆ°ÁêÜ + ‰∏ÄË≤´ÊÄß‰øùË®º
            - **ÂØæÂøúOS**: Android 7.0‰ª•‰∏äÊé®Â•®
            
            ## üéØ ÊäÄË°ìÁöÑÊîπÂñÑÁÇπ
            - ‚úÖ **VANILLA_ICE_CREAM „Ç®„É©„ÉºÊ†πÊú¨Ëß£Ê±∫**: Capacitor 7 + API 35 ÂÖ¨ÂºèË¶Å‰ª∂Ê∫ñÊã†
            - ‚úÖ **ÂÆâÂÆö„Éì„É´„Éâ„ÉÑ„Éº„É´**: AGP 8.5.2 (GitHub ActionsÂØæÂøú) + Java 17 + Node.js 20 LTS
            - ‚úÖ **‰æùÂ≠òÈñ¢‰øÇÊòéÁ§∫Âåñ**: package.json „ÅßCapacitor 7‰æùÂ≠òÈñ¢‰øÇÂÆåÂÖ®ÁÆ°ÁêÜ
            - ‚úÖ **„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞Âº∑Âåñ**: ÊÆµÈöéÁöÑÂ§±ÊïóÊ§úÂá∫„Å®„É≠„Ç∞Âá∫ÂäõÊîπÂñÑ
            
            ---
            ü§ñ **Ëá™Âãï„Éì„É´„Éâ**: GitHub Actions (Phoenix-Build-Capacitor7-Ultimate)  
            üèóÔ∏è **„Éì„É´„ÉâÁï™Âè∑**: ${{ github.run_number }}  
            üìÖ **„Éì„É´„ÉâÊó•ÊôÇ**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
            üîß **ÊäÄË°ìÂàÜÊûê**: Sequential Thinking + Context7 „Å´„Çà„ÇãÊúÄÈÅ©ÂåñÊ∏à„Åø
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
name: Build Laminator Dashboard PWA to APK

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Accept Android SDK Licenses
        run: |
          echo "ğŸ”‘ Accepting Android SDK licenses automatically..."
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses
        
      - name: Update Android SDK to API 35
        run: |
          set -e
          echo "ğŸ“± Updating Android SDK to support API 35 (VANILLA_ICE_CREAM)..."
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-35" "build-tools;35.0.0"
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --update
          echo "âœ… Android SDK updated successfully"
        
      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli @capacitor/core @capacitor/android
        
      - name: Install dependencies
        run: |
          npm init -y
          npm install @capacitor/android @capacitor/core
          
      - name: Prepare and Initialize Capacitor
        run: |
          # --- Webè³‡ç”£ã®æº–å‚™ ---
          sudo apt-get update && sudo apt-get install -y rsync
          mkdir -p www
          rsync -av --exclude='.git*' --exclude='.github' --exclude='node_modules' --exclude='android' ./ www/
          
          # --- Capacitorã®åˆæœŸåŒ–ã¨Androidãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®è¿½åŠ  ---
          cat > capacitor.config.ts << 'EOF'
          import { CapacitorConfig } from '@capacitor/cli';
          const config: CapacitorConfig = {
            appId: 'com.bochang.laminator',
            appName: 'ãƒ©ãƒŸã‚ªãƒšãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
            webDir: 'www',
            bundledWebRuntime: false,
            android: {
              allowMixedContent: true,
              minSdkVersion: 21,
              compileSdkVersion: 35,
              targetSdkVersion: 35,
            },
          };
          export default config;
          EOF
          npx cap add android
          
      - name: Prepare web assets
        run: |
          npx cap copy android
          
      - name: Setup Android Keystore
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "ğŸ“± Using production keystore from GitHub Secrets"
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore
            echo "KEYSTORE_FILE=release.keystore" >> $GITHUB_ENV
            echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
            echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
            echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
            echo "âœ… Production keystore created"
          else
            echo "âš ï¸ KEYSTORE_BASE64 secret not found. App will be unsigned."
          fi

      - name: Configure Build for Signing
        # GitHub Actions ã‚¹ãƒ†ãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®æ¡ä»¶åˆ¶å¾¡ã§HereDocæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’å®Œå…¨å›é¿
        if: env.KEYSTORE_B64_DATA != ''
        env:
          # secretsã‚’ç’°å¢ƒå¤‰æ•°ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦ifæ¡ä»¶ã§å®‰å…¨ã«å‚ç…§
          KEYSTORE_B64_DATA: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_FILE: release.keystore
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          # ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«å³åº§ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’åœæ­¢
          set -e -o pipefail

          echo "ğŸ”‘ Keystore secret is present. Decoding and writing to file..."
          cd android
          # Base64ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          echo -n "$KEYSTORE_B64_DATA" | base64 --decode > app/$KEYSTORE_FILE
          echo "âœ… Keystore file created at android/app/$KEYSTORE_FILE"

          echo "ğŸ”§ Adding signing configuration to build.gradle..."
          # GradleãŒç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿å–ã‚Œã‚‹å½¢å¼ã§ç½²åè¨­å®šã‚’è¿½è¨˜
          cat >> app/build.gradle << 'EOF'

          android {
              compileSdkVersion 35
              signingConfigs {
                  release {
                      storeFile file(System.getenv("KEYSTORE_FILE"))
                      storePassword System.getenv("KEYSTORE_PASSWORD")
                      keyAlias System.getenv("KEY_ALIAS")
                      keyPassword System.getenv("KEY_PASSWORD")
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          EOF
          echo "ğŸ“„ Updated build.gradle with signing configuration"

      - name: Build Android APK
        run: |
          cd android
          echo "ğŸ—ï¸ Starting Android APK build..."
          ./gradlew clean
          ./gradlew assembleRelease --stacktrace
          echo "âœ… APK build completed"

      - name: Verify and Copy APK
        run: |
          echo "ğŸ” Searching for generated APK files..."
          find android -name "*.apk" -type f
          APK_PATH=$(find android/app/build/outputs/apk/release -name "*.apk" | head -1)
          if [ -n "$APK_PATH" ]; then
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            NEW_NAME="laminator-dashboard-v2.16-${TIMESTAMP}.apk"
            echo "âœ… Found APK: $APK_PATH"
            echo "ğŸ“¦ Copying to: $NEW_NAME"
            cp "$APK_PATH" "$NEW_NAME"
            echo "APK_FILENAME=$NEW_NAME" >> $GITHUB_ENV
            echo "ğŸ‰ APK successfully created and copied"
          else
            echo "âŒ APK not found in expected location"
            echo "ğŸ“‚ Full directory listing:"
            find android -type f -name "*.apk"
            exit 1
          fi
          
      - name: Upload APK to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.APK_FILENAME }}
          tag_name: v2.16-build-${{ github.run_number }}
          name: "ğŸ›ï¸ Laminator Dashboard v2.16 Build ${{ github.run_number }}"
          body: |
            # ğŸ›ï¸ ãƒ©ãƒŸã‚ªãƒšãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v2.16
            
            **ğŸ“± è‡ªå‹•ãƒ“ãƒ«ãƒ‰APK** - capacitor-communityå…¬å¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ç½²åæ¸ˆã¿
            
            ## ğŸ“¥ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
            1. â¬‡ï¸ APKãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ğŸ”“ Androidç«¯æœ«ã§ã€Œä¸æ˜ãªã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã‚’è¨±å¯
            3. ğŸ“± APKãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            
            ## âœ¨ Ver.2.16 å…¨æ©Ÿèƒ½
            - â° **æ™‚é–“è¨ˆç®—æ©Ÿ** - ç”Ÿç”£æ™‚é–“ãƒ»çµ‚äº†æ™‚åˆ»äºˆæ¸¬
            - ğŸï¸ **ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†** - æ¶ˆè²»é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³  
            - ğŸ“‹ **ã‚¸ãƒ§ãƒ–ç®¡ç†** - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—è¿½è·¡
            - ğŸ“Š **ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ** - ä½œæ¥­åŠ¹ç‡åˆ†æ
            - ğŸŒ **PWAå¯¾å¿œ** - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œãƒ»ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ 
            - ğŸ”„ **ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹æ›´æ–°** - ç½²åä¸€è²«æ€§ã«ã‚ˆã‚‹ä¸Šæ›¸ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            
            ## ğŸ”§ æŠ€è¡“ä»•æ§˜
            - **ãƒ“ãƒ«ãƒ‰ç’°å¢ƒ**: Ubuntu Latest + Node.js 18 + Java 17
            - **ç½²åæ–¹å¼**: capacitor-community/action-android-release@v1
            - **APKã‚µã‚¤ã‚º**: è‡ªå‹•æœ€é©åŒ–æ¸ˆã¿
            - **å¯¾å¿œOS**: Android 7.0ä»¥ä¸Šæ¨å¥¨
            
            ---
            ğŸ¤– **è‡ªå‹•ãƒ“ãƒ«ãƒ‰**: GitHub Actions  
            ğŸ—ï¸ **ãƒ“ãƒ«ãƒ‰ç•ªå·**: ${{ github.run_number }}  
            ğŸ“… **ãƒ“ãƒ«ãƒ‰æ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
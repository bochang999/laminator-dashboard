name: Build Laminator Dashboard PWA to APK

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli @capacitor/core @capacitor/android
        
      - name: Install dependencies
        run: |
          npm init -y
          npm install @capacitor/android @capacitor/core
          
      - name: Prepare and Initialize Capacitor
        run: |
          # --- Webè³‡ç”£ã®æº–å‚™ ---
          sudo apt-get update && sudo apt-get install -y rsync
          mkdir -p www
          rsync -av --exclude='.git*' --exclude='.github' --exclude='node_modules' --exclude='android' ./ www/
          
          # --- Capacitorã®åˆæœŸåŒ–ã¨Androidãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®è¿½åŠ  ---
          cat > capacitor.config.ts << 'EOF'
          import { CapacitorConfig } from '@capacitor/cli';
          const config: CapacitorConfig = {
            appId: 'com.bochang.laminator',
            appName: 'ãƒ©ãƒŸã‚ªãƒšãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
            webDir: 'www',
            bundledWebRuntime: false,
            android: {
              allowMixedContent: true,
            },
          };
          export default config;
          EOF
          npx cap add android
          
      - name: Copy web assets
        run: |
          npx cap copy android
          
      - name: Create laminator-dashboard keystore
        working-directory: android
        run: |
          if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "KEYSTORE_BASE64 secret is not set! Creating development keystore..."
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é–‹ç™ºç”¨ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ã‚’å‹•çš„ç”Ÿæˆ
            keytool -genkeypair -v -keystore app/laminator-dashboard.keystore \
              -alias laminator -keyalg RSA -keysize 2048 -validity 10000 \
              -dname "CN=Laminator,O=BochangDev,C=JP" \
              -storepass laminator123 -keypass laminator123
          else
            echo "Using keystore from GitHub Secrets..."
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/laminator-dashboard.keystore
          fi
          
      - name: Configure Android signing
        working-directory: android
        run: |
          # ç½²åç’°å¢ƒå¤‰æ•°ã®è¨­å®š
          export LAMINATOR_STORE_FILE="laminator-dashboard.keystore"
          export LAMINATOR_STORE_PASSWORD="${{ secrets.KEYSTORE_PASSWORD || 'laminator123' }}"
          export LAMINATOR_KEY_ALIAS="${{ secrets.KEY_ALIAS || 'laminator' }}"
          export LAMINATOR_KEY_PASSWORD="${{ secrets.KEY_PASSWORD || 'laminator123' }}"
          
          # build.gradleã«ç½²åè¨­å®šã‚’è¿½åŠ 
          cat >> app/build.gradle << 'EOF'
          
          android {
              signingConfigs {
                  release {
                      storeFile file(System.getenv("LAMINATOR_STORE_FILE") ?: "laminator-dashboard.keystore")
                      storePassword System.getenv("LAMINATOR_STORE_PASSWORD") ?: "laminator123"
                      keyAlias System.getenv("LAMINATOR_KEY_ALIAS") ?: "laminator"
                      keyPassword System.getenv("LAMINATOR_KEY_PASSWORD") ?: "laminator123"
                  }
              }
              
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
                  debug {
                      signingConfig signingConfigs.release
                  }
              }
          }
          EOF
          
      - name: Build Android APK
        working-directory: android
        env:
          LAMINATOR_STORE_FILE: "laminator-dev-key.jks"
          LAMINATOR_STORE_PASSWORD: "laminator123"
          LAMINATOR_KEY_ALIAS: "laminator"
          LAMINATOR_KEY_PASSWORD: "laminator123"
        run: |
          ./gradlew assembleRelease --no-daemon --stacktrace
          
      - name: Sign and optimize APK
        working-directory: android
        run: |
          # APKãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          find . -name "*.apk" -type f
          
          # ãƒªãƒªãƒ¼ã‚¹APKã‚’æ¤œç´¢
          APK_FILE=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          if [ -n "$APK_FILE" ]; then
            echo "Found APK: $APK_FILE"
            cp "$APK_FILE" ../laminator-dashboard-v$(date +%Y%m%d-%H%M%S).apk
          fi
          
      - name: Upload APK to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: laminator-dashboard-v*.apk
          tag_name: v2.16-build-${{ github.run_number }}
          name: "Laminator Dashboard v2.16 Build ${{ github.run_number }}"
          body: |
            ðŸŽ›ï¸ **ãƒ©ãƒŸã‚ªãƒšãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v2.16**
            
            è‡ªå‹•ãƒ“ãƒ«ãƒ‰ APK - GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆ
            
            ## ðŸ“± ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
            1. APKãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. Androidç«¯æœ«ã§ã€Œä¸æ˜Žãªã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã‚’è¨±å¯
            3. APKãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            
            ## âœ¨ Ver.2.16 æ©Ÿèƒ½
            - æ™‚é–“è¨ˆç®—æ©Ÿï¼ˆç”Ÿç”£æ™‚é–“ãƒ»çµ‚äº†æ™‚åˆ»äºˆæ¸¬ï¼‰
            - ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
            - ã‚¸ãƒ§ãƒ–ç®¡ç†ãƒ»é€²æ—è¿½è·¡
            - ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ©Ÿèƒ½
            - PWAå¯¾å¿œï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œï¼‰
            
            ðŸ¤– Generated with GitHub Actions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
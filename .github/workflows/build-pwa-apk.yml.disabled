name: Build Laminator Dashboard PWA to APK (Capacitor 7 + API 35)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Node.js 20 LTS
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Accept Android SDK Licenses
        run: |
          echo "ğŸ”‘ Accepting Android SDK licenses automatically..."
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses
        
      - name: Update Android SDK to API 35 (Capacitor 7 Compatible)
        run: |
          set -e
          echo "ğŸ“± Installing Android SDK API 35 for Capacitor 7..."
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-35" "build-tools;35.0.0"
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-34" "build-tools;34.0.0"
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --update
          echo "âœ… Android SDK updated to API 35 successfully"
        
      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ Installing package.json dependencies..."
          npm install
        
      - name: Prepare Web Assets
        run: |
          echo "ğŸ“‚ Preparing web assets for Capacitor 7..."
          sudo apt-get update && sudo apt-get install -y rsync
          mkdir -p www
          rsync -av --exclude='.git*' --exclude='.github' --exclude='node_modules' --exclude='android' ./ www/
          echo "âœ… Web assets prepared"
          
      - name: Initialize Capacitor 7 with API 35 Configuration
        run: |
          echo "âš¡ Initializing Capacitor 7 with Android API 35..."
          cat > capacitor.config.ts << 'EOF'
          import { CapacitorConfig } from '@capacitor/cli';
          const config: CapacitorConfig = {
            appId: 'com.bochang.laminator',
            appName: 'ãƒ©ãƒŸã‚ªãƒšãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
            webDir: 'www',
            bundledWebRuntime: false,
            android: {
              allowMixedContent: true,
              minSdkVersion: 23,
              compileSdkVersion: 35,
              targetSdkVersion: 35,
            },
          };
          export default config;
          EOF
          
          echo "ğŸ”§ Adding Android platform with Capacitor 7..."
          npx cap add android
          
          echo "ğŸ“‹ Configuring variables.gradle for Capacitor 7 + API 35..."
          cat > android/variables.gradle << 'EOF'
          ext {
              minSdkVersion = 23
              compileSdkVersion = 35
              targetSdkVersion = 35
              androidxActivityVersion = '1.9.2'
              androidxAppCompatVersion = '1.7.0'
              androidxCoordinatorLayoutVersion = '1.2.0'
              androidxCoreVersion = '1.15.0'
              androidxFragmentVersion = '1.8.4'
              coreSplashScreenVersion = '1.0.1'
              androidxWebkitVersion = '1.12.1'
              junitVersion = '4.13.2'
              androidxJunitVersion = '1.2.1'
              androidxEspressoCoreVersion = '3.6.1'
              cordovaAndroidVersion = '10.1.1'
          }
          EOF
          echo "âœ… Capacitor 7 initialization complete"
          
      - name: Copy Web Assets to Android
        run: |
          echo "ğŸ“± Copying web assets to Android platform..."
          npx cap copy android
          echo "âœ… Assets copied successfully"
          
      - name: Fix Plugin Repository with settings.gradle & AGP 8.5.2
        run: |
          echo "ğŸ”§ Emergency downgrade to AGP 8.5.2 for GitHub Actions compatibility..."
          cd android
          
          # Create settings.gradle with pluginManagement (Correct Plugin Repository Fix)
          cat > settings.gradle << 'EOF'
          pluginManagement {
              repositories {
                  gradlePluginPortal()   // Essential for plugin resolution  
                  google()
                  mavenCentral()
              }
          }
          EOF
          
          # Update project-level build.gradle (without pluginManagement)
          cat > build.gradle << 'EOF'
          // Top-level build file where you can add configuration options common to all sub-projects/modules.

          plugins {
              id 'com.android.application' version '8.5.2' apply false
              id 'com.android.library' version '8.5.2' apply false
              id 'com.google.gms.google-services' version '4.4.2' apply false
          }

          repositories {
              google()
              mavenCentral()
          }

          task clean(type: Delete) {
              delete rootProject.buildDir
          }
          EOF
          echo "âœ… Android Gradle Plugin downgraded to 8.5.2 (GitHub Actions Compatible)"
          
      - name: Setup Android Keystore
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "ğŸ“± Using production keystore from GitHub Secrets"
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore
            echo "KEYSTORE_FILE=release.keystore" >> $GITHUB_ENV
            echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
            echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
            echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
            echo "âœ… Production keystore created"
          else
            echo "âš ï¸ KEYSTORE_BASE64 secret not found. App will be unsigned."
          fi

      - name: Configure Build for Capacitor 7 + API 35 Signing
        if: env.KEYSTORE_B64_DATA != ''
        env:
          KEYSTORE_B64_DATA: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_FILE: release.keystore
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          set -e -o pipefail

          echo "ğŸ”‘ Configuring Capacitor 7 + API 35 signing..."
          cd android
          echo -n "$KEYSTORE_B64_DATA" | base64 --decode > app/$KEYSTORE_FILE
          echo "âœ… Keystore file created at android/app/$KEYSTORE_FILE"

          echo "ğŸ”§ Creating unified Capacitor 7 + API 35 build.gradle (é‡è¤‡android{}ãƒ–ãƒ­ãƒƒã‚¯è§£æ±º)..."
          cat > app/build.gradle << 'EOF'
          plugins {
              id 'com.android.application'
          }

          android {
              compileSdkVersion 35
              namespace "com.bochang.laminator"
              
              defaultConfig {
                  applicationId "com.bochang.laminator"
                  minSdkVersion 23
                  targetSdkVersion 35
                  versionCode 1
                  versionName "2.16"
                  testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
              }
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              
              signingConfigs {
                  release {
                      storeFile file(System.getenv("KEYSTORE_FILE"))
                      storePassword System.getenv("KEYSTORE_PASSWORD")
                      keyAlias System.getenv("KEY_ALIAS")
                      keyPassword System.getenv("KEY_PASSWORD")
                  }
              }
              
              buildTypes {
                  release {
                      minifyEnabled true
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                      signingConfig signingConfigs.release
                  }
              }
          }

          dependencies {
              implementation 'androidx.appcompat:appcompat:1.7.0'
              implementation 'androidx.core:core:1.15.0'
              implementation 'com.capacitor:core:7.0.0'
              testImplementation 'junit:junit:4.13.2'
              androidTestImplementation 'androidx.test.ext:junit:1.2.1'
              androidTestImplementation 'androidx.test.espresso:espresso-core:3.6.1'
          }
          EOF
          echo "âœ… Capacitor 7 + API 35 unified build configuration complete"

      - name: Build Android APK with Capacitor 7
        run: |
          echo "ğŸ—ï¸ Starting Capacitor 7 + API 35 Android APK build..."
          cd android
          
          echo "ğŸ§¹ Cleaning previous builds..."
          ./gradlew clean
          
          echo "ğŸ“‹ Displaying Gradle version and configuration..."
          ./gradlew --version
          
          echo "ğŸ”¨ Building release APK with enhanced error handling..."
          ./gradlew assembleRelease --stacktrace --info --debug > build.log 2>&1 || {
            echo "âŒ Build failed. Analyzing build log comprehensively..."
            echo "ğŸ” FIRST 30 LINES (Root Cause Detection):"
            head -30 build.log
            echo ""
            echo "ğŸ” ERROR/FAILURE SECTIONS (Specific Issues):"
            grep -A 3 -B 3 -i "FAILURE\|BUILD FAILED\|Error\|Exception" build.log | head -30
            echo ""
            echo "ğŸ” LAST 30 LINES (Stack Trace End):"
            tail -30 build.log
            exit 1
          }
          
          echo "âœ… Capacitor 7 + API 35 APK build completed successfully"

      - name: Verify and Package APK
        run: |
          echo "ğŸ” Searching for generated APK files..."
          find android -name "*.apk" -type f
          
          APK_PATH=$(find android/app/build/outputs/apk/release -name "*.apk" | head -1)
          if [ -n "$APK_PATH" ]; then
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            NEW_NAME="laminator-dashboard-capacitor7-v2.16-${TIMESTAMP}.apk"
            echo "âœ… Found APK: $APK_PATH"
            echo "ğŸ“¦ Packaging as: $NEW_NAME"
            cp "$APK_PATH" "$NEW_NAME"
            echo "APK_FILENAME=$NEW_NAME" >> $GITHUB_ENV
            
            echo "ğŸ“Š APK Information:"
            ls -lh "$NEW_NAME"
            echo "ğŸ‰ Capacitor 7 + API 35 APK successfully created and packaged"
          else
            echo "âŒ APK not found in expected location"
            echo "ğŸ“‚ Full directory structure:"
            find android -type f -name "*.apk"
            echo "ğŸ“‚ Build outputs structure:"
            find android/app/build -name "*.apk" 2>/dev/null || echo "No APK found in build outputs"
            exit 1
          fi
          
      - name: Upload Capacitor 7 APK to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.APK_FILENAME }}
          tag_name: v2.16-capacitor7-build-${{ github.run_number }}
          name: "ğŸš€ Laminator Dashboard v2.16 Capacitor 7 Build ${{ github.run_number }}"
          body: |
            # ğŸ›ï¸ ãƒ©ãƒŸã‚ªãƒšãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v2.16 (Capacitor 7 + API 35)
            
            **ğŸš€ VANILLA_ICE_CREAM å•é¡Œå®Œå…¨è§£æ±ºç‰ˆ** - Capacitor 7 + Android API 35 + AGP 8.5.2
            
            ## ğŸ“¥ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
            1. â¬‡ï¸ APKãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ğŸ”“ Androidç«¯æœ«ã§ã€Œä¸æ˜ãªã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã‚’è¨±å¯
            3. ğŸ“± APKãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            
            ## âœ¨ Ver.2.16 å…¨æ©Ÿèƒ½
            - â° **æ™‚é–“è¨ˆç®—æ©Ÿ** - ç”Ÿç”£æ™‚é–“ãƒ»çµ‚äº†æ™‚åˆ»äºˆæ¸¬
            - ğŸï¸ **ãƒ•ã‚£ãƒ«ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†** - æ¶ˆè²»é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³  
            - ğŸ“‹ **ã‚¸ãƒ§ãƒ–ç®¡ç†** - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—è¿½è·¡
            - ğŸ“Š **ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ** - ä½œæ¥­åŠ¹ç‡åˆ†æ
            - ğŸŒ **PWAå¯¾å¿œ** - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œãƒ»ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ 
            - ğŸ”„ **ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹æ›´æ–°** - ç½²åä¸€è²«æ€§ã«ã‚ˆã‚‹ä¸Šæ›¸ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            
            ## ğŸ”§ æŠ€è¡“ä»•æ§˜
            - **ãƒ“ãƒ«ãƒ‰ç’°å¢ƒ**: Ubuntu Latest + Node.js 20 LTS + Java 17
            - **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Capacitor 7.0.0 + Android API 35
            - **ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«**: Android Gradle Plugin 8.5.2 + Gradle 8.11
            - **ç½²åæ–¹å¼**: è‡ªå‹•ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ç®¡ç† + ä¸€è²«æ€§ä¿è¨¼
            - **å¯¾å¿œOS**: Android 7.0ä»¥ä¸Šæ¨å¥¨
            
            ## ğŸ¯ æŠ€è¡“çš„æ”¹å–„ç‚¹
            - âœ… **VANILLA_ICE_CREAM ã‚¨ãƒ©ãƒ¼æ ¹æœ¬è§£æ±º**: Capacitor 7 + API 35 å…¬å¼è¦ä»¶æº–æ‹ 
            - âœ… **å®‰å®šãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«**: AGP 8.5.2 (GitHub Actionså¯¾å¿œ) + Java 17 + Node.js 20 LTS
            - âœ… **ä¾å­˜é–¢ä¿‚æ˜ç¤ºåŒ–**: package.json ã§Capacitor 7ä¾å­˜é–¢ä¿‚å®Œå…¨ç®¡ç†
            - âœ… **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–**: æ®µéšçš„å¤±æ•—æ¤œå‡ºã¨ãƒ­ã‚°å‡ºåŠ›æ”¹å–„
            
            ---
            ğŸ¤– **è‡ªå‹•ãƒ“ãƒ«ãƒ‰**: GitHub Actions (Phoenix-Build-Capacitor7-Ultimate)  
            ğŸ—ï¸ **ãƒ“ãƒ«ãƒ‰ç•ªå·**: ${{ github.run_number }}  
            ğŸ“… **ãƒ“ãƒ«ãƒ‰æ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
            ğŸ”§ **æŠ€è¡“åˆ†æ**: Sequential Thinking + Context7 ã«ã‚ˆã‚‹æœ€é©åŒ–æ¸ˆã¿
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
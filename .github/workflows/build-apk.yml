name: Build Laminator Dashboard APK (Ephemeral Capacitor)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    env:
      NODE_VERSION: '20'
      JAVA_VERSION: '17'          # JDK 17 for AGP 8.5 stability (String.call() fix)
      APP_ID: com.bochang.laminator
      APP_NAME: 'Laminator Dashboard'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android SDK Build Tools Path
        run: |
          echo "Setting up Android SDK Build Tools path..."
          BUILD_TOOLS_PATH=$(find $ANDROID_HOME/build-tools -maxdepth 1 | sort -r | head -n 1)
          echo "Found Build Tools at: $BUILD_TOOLS_PATH"
          echo "$BUILD_TOOLS_PATH" >> $GITHUB_PATH
          echo "âœ… Android SDK Build-Tools added to PATH."

      - name: Accept Android licenses
        run: yes | sdkmanager --licenses >/dev/null

      - name: Install API 35 components
        run: |
          echo "ğŸ“± Installing Android SDK API 35 for Capacitor 7..."
          sdkmanager "platforms;android-35" "build-tools;35.0.0"
          echo "âœ… Android SDK components installed successfully"

      - name: Install dependencies
        run: npm install

      - name: ğŸ•µï¸ Analyze Installed Dependencies
        run: |
          echo "--- NPM Dependency Tree ---"
          npm list
          echo "--- End of NPM Dependency Tree ---"

      - name: Prepare Web Directory for Capacitor
        run: |
          echo "ğŸ§¹ Cleaning www directory..."
          rm -rf www
          echo "ğŸ“¦ Rebuilding www directory..."
          mkdir -p www/assets
          cp -r *.html *.css *.js *.json www/ 2>/dev/null || true
          echo "ğŸ–¼ï¸ Copying master icon into www directory..."
          if [ -f "assets/icon.png" ]; then
            cp assets/icon.png www/assets/icon.png
            echo "âœ… Master icon copied to www/assets/"
          else
            echo "âš ï¸ assets/icon.png not found, using default"
          fi
          if [ -f "assets/splash.png" ]; then
            cp assets/splash.png www/assets/splash.png
            echo "âœ… Splash screen copied to www/assets/"
          fi
          echo "âœ… Web directory prepared with clean assets"

      - name: Detect webDir (robust)
        id: detect
        run: |
          echo "ğŸ” Detecting webDir location with robust method..."
          for d in dist build www public; do
            if [ -f "$d/index.html" ]; then
              echo "âœ… Found index.html in: $d"
              echo "webdir=$d" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
          echo "::error::index.html not found in any expected directory"
          exit 1

      - name: Clean Capacitor Setup (Ephemeral Init)
        run: |
          echo "ğŸ§¹ Ensuring clean Capacitor initialization state..."
          rm -rf capacitor.config.* android ios electron
          echo "âœ… Previous Capacitor artifacts removed"

      - name: Initialize Capacitor (Fresh Start)
        run: |
          echo "âš¡ Fresh Capacitor initialization without config conflicts..."
          echo "ğŸ“‚ Using webDir: ${{ steps.detect.outputs.webdir }}"
          
          # Initialize Capacitor with detected webDir
          npx cap init "${{ env.APP_NAME }}" "${{ env.APP_ID }}" --web-dir="${{ steps.detect.outputs.webdir }}"
          
          echo "ğŸ”§ Adding Android platform..."
          npx cap add android
          
          echo "âœ… Capacitor initialization completed successfully"

      - name: Generate App Icons and Splash Screen
        run: |
          echo "ğŸ¨ Generating app icons and splash screen..."
          
          # ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å­˜åœ¨ç¢ºèª
          if [ ! -d "android" ]; then
            echo "âŒ Android platform not found - aborting icon generation"
            exit 1
          fi
          
          # ã‚½ãƒ¼ã‚¹ã‚¢ã‚»ãƒƒãƒˆç¢ºèª
          if [ -f "assets/icon.png" ] && [ -f "assets/splash.png" ]; then
            echo "âœ… Source assets found:"
            echo "  ğŸ“„ assets/icon.png ($(stat -f%z assets/icon.png 2>/dev/null || stat -c%s assets/icon.png) bytes)"
            echo "  ğŸ“„ assets/splash.png ($(stat -f%z assets/splash.png 2>/dev/null || stat -c%s assets/splash.png) bytes)"
            
            echo "ğŸ”¨ Generating Android icons and splash screens..."
            npx @capacitor/assets generate --android --verbose
            
            # ç”Ÿæˆçµæœç¢ºèª
            if [ -d "android/app/src/main/res" ]; then
              echo "âœ… Icon generation successful! Generated files:"
              find android/app/src/main/res -name "*ic_launcher*" -o -name "*splash*" | sort
            else
              echo "âš ï¸ Icon generation may have failed - res directory not found"
            fi
            
            echo "âœ… App icons and splash screen generated successfully"
          else
            echo "âš ï¸ Source assets not found (assets/icon.png or assets/splash.png missing)"
            echo "ğŸ“‹ Available files in assets/:"
            ls -la assets/ || echo "âŒ No assets folder found"
            echo "ğŸ“‹ Current directory contents:"
            ls -la
            exit 1
          fi

      - name: Sync Capacitor
        run: |
          echo "âš¡ Syncing Capacitor..."
          npx cap sync android
          echo "âœ… Capacitor sync completed"

      - name: Configure Build Gradle for Command-line Version Injection
        run: |
          echo "ğŸ”§ Configuring build.gradle for command-line version injection..."
          
          # build.gradleã‚’æ’ä¹…çš„ã«ä¿®æ­£ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰
          if [ -f android/app/build.gradle ]; then
            echo "ğŸ“ Updating build.gradle to support -P parameter injection..."
            
            # versionCodeã¨versionNameã‚’ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³æ³¨å…¥å¯¾å¿œã«å¤‰æ›´
            sed -i 's/versionCode .*/versionCode project.hasProperty('\''android.injected.versionCode'\'') ? project.property('\''android.injected.versionCode'\'').toInteger() : 1/' android/app/build.gradle
            sed -i 's/versionName .*/versionName project.hasProperty('\''android.injected.versionName'\'') ? project.property('\''android.injected.versionName'\'') : "1.0"/' android/app/build.gradle
            
            echo "âœ… build.gradle configured for command-line version injection"
          else
            echo "âš ï¸ build.gradle not found, skipping configuration"
          fi

      - name: Configure Android API 35 Settings
        run: |
          echo "ğŸ“± Configuring Android for API 35 (VANILLA_ICE_CREAM)..."
          
          # variables.gradle ã§API 35è¨­å®š
          if [ -f android/variables.gradle ]; then
            echo "ğŸ”§ Updating variables.gradle for API 35..."
            cat > android/variables.gradle <<'EOF'
          ext {
              minSdkVersion = 24
              compileSdkVersion = 35
              targetSdkVersion = 35
              androidxActivityVersion = '1.9.2'
              androidxAppCompatVersion = '1.7.0'
              androidxCoordinatorLayoutVersion = '1.2.0'
              androidxCoreVersion = '1.15.0'
              androidxFragmentVersion = '1.8.4'
              coreSplashScreenVersion = '1.0.1'
              androidxWebkitVersion = '1.12.1'
              junitVersion = '4.13.2'
              androidxJunitVersion = '1.2.1'
              androidxEspressoCoreVersion = '3.6.1'
              cordovaAndroidVersion = '10.1.1'
          }
          EOF
            echo "âœ… variables.gradle configured for API 35"
          fi
          
          # build.gradle ã® Android Gradle Plugin ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨­å®š
          if [ -f android/build.gradle ]; then
            echo "ğŸ”§ Configuring AGP version for API 35 compatibility..."
            sed -i "s/id 'com.android.application' version '[^']*'/id 'com.android.application' version '8.5.2'/" android/build.gradle
            sed -i "s/id 'com.android.library' version '[^']*'/id 'com.android.library' version '8.5.2'/" android/build.gradle
            echo "âœ… AGP configured for API 35 compatibility"
          fi

      - name: Set Version Information
        run: |
          echo "ğŸ“‹ Setting version information for Ver.8.3 String.call() Fix + Fingerprint Gate..."
          VERSION_MAJOR="8"
          VERSION_MINOR="3"
          VERSION_PATCH="${{ github.run_number }}"
          VERSION_TAG="$VERSION_MAJOR.$VERSION_MINOR.$VERSION_PATCH"
          # Ensure versionCode monotonic increase (80000 + run_number)
          VERSION_CODE=$((80000 + ${{ github.run_number }}))
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "âœ… Version tag set to: $VERSION_TAG (Code: $VERSION_CODE)"

      - name: Pre-Build Cleanup
        run: |
          echo "ğŸ§¹ Pre-build cleanup..."
          cd android
          ./gradlew clean || echo "Clean skipped (first run)"
          cd ..

      - name: Restore Official Keystore from GitHub Secrets
        run: |
          echo "ğŸ”‘ Configuring keystore for consistent APK signing..."
          cd android
          
          # Check if GitHub Secrets are properly configured
          if [ -n "${{ secrets.KEYSTORE_B64 }}" ] && [ -n "${{ secrets.KEYSTORE_PASSWORD }}" ] && [ -n "${{ secrets.KEY_ALIAS }}" ] && [ -n "${{ secrets.KEY_PASSWORD }}" ]; then
            echo "âœ… GitHub Secrets detected - restoring persistent keystore..."
            
            # Restore keystore from GitHub Secrets
            echo "${{ secrets.KEYSTORE_B64 }}" | base64 -d > laminator-official.keystore 2>/dev/null || \
            echo "${{ secrets.KEYSTORE_B64 }}" | base64 --decode > laminator-official.keystore 2>/dev/null
            
            # Verify keystore file was created
            if [ ! -f "laminator-official.keystore" ]; then
              echo "âŒ Failed to create keystore file from Secrets"
              exit 1
            fi
            
            # Verify keystore integrity and alias
            if keytool -list -keystore laminator-official.keystore -alias "${{ secrets.KEY_ALIAS }}" -storepass "${{ secrets.KEYSTORE_PASSWORD }}" >/dev/null 2>&1; then
              echo "âœ… Keystore restored and verified successfully"
              echo "ğŸ” Using persistent keystore for consistent signing"
            else
              echo "âŒ Keystore verification failed - alias '${{ secrets.KEY_ALIAS }}' not found or wrong password"
              echo "ğŸ“‹ Available aliases in keystore:"
              keytool -list -keystore laminator-official.keystore -storepass "${{ secrets.KEYSTORE_PASSWORD }}" | grep "Alias name:" || true
              exit 1
            fi
            
            # Set environment variables for persistent signing
            echo "KEYSTORE_FILE=laminator-official.keystore" >> $GITHUB_ENV
            echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
            echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
            echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
            echo "SIGNING_MODE=github-secrets-persistent" >> $GITHUB_ENV
            
          else
            echo "âš ï¸ GitHub Secrets not configured - using bootstrap keystore"
            echo "ğŸš¨ WARNING: This will create signature incompatibility with existing installations"
            echo ""
            echo "ğŸ“‹ TO FIX THIS PERMANENTLY:"
            echo "   1. Generate permanent keystore locally:"
            echo "      keytool -genkeypair -v -keystore laminator-official.keystore \\"
            echo "        -alias laminator-official -keyalg RSA -keysize 4096 -validity 36500 \\"
            echo "        -dname \"CN=Laminator Dashboard,O=BochangDev,C=JP\" \\"
            echo "        -storepass [YOUR_PASSWORD] -keypass [YOUR_PASSWORD]"
            echo ""
            echo "   2. Encode keystore to base64:"
            echo "      base64 -w 0 laminator-official.keystore   # Linux"
            echo "      base64 laminator-official.keystore | tr -d '\\n'   # macOS"
            echo ""
            echo "   3. Add these GitHub Secrets to repository:"
            echo "      KEYSTORE_B64: [base64 encoded keystore file]"
            echo "      KEYSTORE_PASSWORD: [your keystore password]"
            echo "      KEY_ALIAS: laminator-official"
            echo "      KEY_PASSWORD: [your key password - usually same as keystore password]"
            echo ""
            
            # Create bootstrap keystore for initial setup only
            keytool -genkeypair -v -keystore laminator-bootstrap.keystore \
              -alias laminator-bootstrap -keyalg RSA -keysize 4096 -validity 36500 \
              -dname "CN=Laminator Dashboard Bootstrap,O=BochangDev,C=JP" \
              -storepass bootstrap2025temp -keypass bootstrap2025temp
            
            echo "ğŸ—ï¸ Created bootstrap keystore (TEMPORARY - will cause update issues)"
            
            # Set environment variables for bootstrap signing
            echo "KEYSTORE_FILE=laminator-bootstrap.keystore" >> $GITHUB_ENV
            echo "KEYSTORE_PASSWORD=bootstrap2025temp" >> $GITHUB_ENV
            echo "KEY_ALIAS=laminator-bootstrap" >> $GITHUB_ENV
            echo "KEY_PASSWORD=bootstrap2025temp" >> $GITHUB_ENV
            echo "SIGNING_MODE=bootstrap-temporary" >> $GITHUB_ENV
          fi
          
          # Display current signing configuration
          echo "ğŸ“Š Current Signing Configuration:"
          echo "   ğŸ”‘ Keystore: $KEYSTORE_FILE"
          echo "   ğŸ‘¤ Alias: $KEY_ALIAS"  
          echo "   ğŸ“‹ Mode: $SIGNING_MODE"
          
          cd ..

      - name: Skip Golden Gradle Template (Not Needed for Capacitor Official Signing)
        run: |
          echo "â„¹ï¸ Skipping golden template - using Capacitor official signing configuration instead..."
          echo "âœ… Template step skipped for Capacitor methodology."

      - name: Create Static Gradle Signing Configuration
        run: |
          echo "ğŸ”§ Creating static build.gradle signing configuration (String.call() fix)..."
          
          if [ -f android/app/build.gradle ]; then
            echo "ğŸ“ Backing up original build.gradle..."
            cp android/app/build.gradle android/app/build.gradle.backup
            
            echo "ğŸ“ Injecting static signing configuration block..."
            
            # Create static signing configuration that uses Gradle properties (-P flags)
            cat > android/app/build.gradle.signing <<'EOF'

    signingConfigs {
        release {
            // Use Gradle properties passed via -P flags (no variable name conflicts)
            storeFile file(project.hasProperty('LAMINATOR_STORE_FILE') ? project.property('LAMINATOR_STORE_FILE') : '')
            storePassword project.hasProperty('LAMINATOR_STORE_PASSWORD') ? project.property('LAMINATOR_STORE_PASSWORD') : ''
            keyAlias project.hasProperty('LAMINATOR_KEY_ALIAS') ? project.property('LAMINATOR_KEY_ALIAS') : ''
            keyPassword project.hasProperty('LAMINATOR_KEY_PASSWORD') ? project.property('LAMINATOR_KEY_PASSWORD') : ''
        }
        debug {
            // Use same signing as release for update compatibility
            storeFile file(project.hasProperty('LAMINATOR_STORE_FILE') ? project.property('LAMINATOR_STORE_FILE') : '')
            storePassword project.hasProperty('LAMINATOR_STORE_PASSWORD') ? project.property('LAMINATOR_STORE_PASSWORD') : ''
            keyAlias project.hasProperty('LAMINATOR_KEY_ALIAS') ? project.property('LAMINATOR_KEY_ALIAS') : ''
            keyPassword project.hasProperty('LAMINATOR_KEY_PASSWORD') ? project.property('LAMINATOR_KEY_PASSWORD') : ''
        }
    }

    buildTypes {
        release {
            signingConfig signingConfigs.release
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
        debug {
            signingConfig signingConfigs.debug
            debuggable true
        }
    }
EOF

            # Insert the signing configuration after the android { line
            awk '
            /^[[:space:]]*android[[:space:]]*{/ {
                print $0
                system("cat android/app/build.gradle.signing")
                next
            }
            /^[[:space:]]*signingConfigs[[:space:]]*{/,/^[[:space:]]*}[[:space:]]*$/ {
                next
            }
            /^[[:space:]]*buildTypes[[:space:]]*{/,/^[[:space:]]*}[[:space:]]*$/ {
                next
            }
            { print }
            ' android/app/build.gradle.backup > android/app/build.gradle
            
            # Clean up temporary files
            rm -f android/app/build.gradle.signing android/app/build.gradle.backup
            
            echo "âœ… Static signing configuration injected successfully"
            
            # Verify the configuration was added
            echo "ğŸ“‹ Verifying signing configuration:"
            if grep -A 5 "signingConfigs" android/app/build.gradle; then
              echo "âœ… Signing configuration verification successful"
            else
              echo "âŒ Failed to verify signing configuration"
              exit 1
            fi
          else
            echo "âŒ android/app/build.gradle not found - cannot configure signing"
            exit 1
          fi

      - name: Build Signed APK with Gradle Properties (-P Direct Injection)
        working-directory: android
        run: |
          echo "ğŸ—ï¸ Building APK with Gradle properties for signing (String.call() fix)..."
          chmod +x gradlew
          
          echo "ğŸ”¨ Building signed release APK with -P flags..."
          ./gradlew clean assembleRelease \
            --no-daemon --stacktrace \
            -Pandroid.injected.versionName="${{ env.VERSION_TAG }}" \
            -Pandroid.injected.versionCode="${{ env.VERSION_CODE }}" \
            -PLAMINATOR_STORE_FILE=${{ github.workspace }}/android/${{ env.KEYSTORE_FILE }} \
            -PLAMINATOR_STORE_PASSWORD=${{ env.KEYSTORE_PASSWORD }} \
            -PLAMINATOR_KEY_ALIAS=${{ env.KEY_ALIAS }} \
            -PLAMINATOR_KEY_PASSWORD=${{ env.KEY_PASSWORD }}
          
          cd ..
          
          # APKç¢ºèª
          if [ -f "android/app/build/outputs/apk/release/app-release.apk" ]; then
              echo "âœ… Release APK created successfully"
              APK_SOURCE="android/app/build/outputs/apk/release/app-release.apk"
              BUILD_TYPE="release"
          elif [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
              echo "âœ… Debug APK created successfully"
              APK_SOURCE="android/app/build/outputs/apk/debug/app-debug.apk"
              BUILD_TYPE="debug"
          else
              echo "âŒ No APK found"
              find android -name "*.apk" -type f || echo "No APK files found anywhere"
              exit 1
          fi
          
          # æœ€çµ‚APKãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          FINAL_NAME="lamidash_${{ env.VERSION_TAG }}_capacitor_official.apk"
          cp "$APK_SOURCE" "$FINAL_NAME"
          
          echo "âœ… Official Capacitor signed APK created: $FINAL_NAME"
          echo "ğŸ“Š APK Information:"
          ls -lh "$FINAL_NAME"
          
          # APKç½²åæ¤œè¨¼
          if command -v apksigner >/dev/null 2>&1; then
            echo "ğŸ” Verifying APK signature..."
            apksigner verify --verbose "$FINAL_NAME" || echo "âš ï¸ Signature verification warning"
          fi
          
          echo "APK_FILE=$FINAL_NAME" >> $GITHUB_ENV
          echo "BUILD_TYPE=$BUILD_TYPE" >> $GITHUB_ENV

      - name: Signature Fingerprint Gate (Critical Security Check)
        run: |
          echo "ğŸ›¡ï¸ Executing signature fingerprint gate for consistency..."
          
          APK_FILE=$(find . -name "lamidash_*.apk" | head -n 1)
          if [ ! -f "$APK_FILE" ]; then
            echo "âŒ APK file not found for fingerprint gate"
            exit 1
          fi
          
          echo "ğŸ“‹ Analyzing APK: $APK_FILE"
          echo "ğŸ”§ Signing Mode: ${{ env.SIGNING_MODE }}"
          
          # Extract signature fingerprint
          if command -v apksigner >/dev/null 2>&1; then
            echo "ğŸ” Extracting signature fingerprint..."
            apksigner verify --print-certs "$APK_FILE" 2>/dev/null | sed -n 's/.*SHA-256 digest: //p' > current_fingerprint.txt
            
            if [ ! -s current_fingerprint.txt ]; then
              echo "âŒ Failed to extract signature fingerprint"
              exit 1
            fi
            
            CURRENT_FINGERPRINT=$(cat current_fingerprint.txt | tr -d ' \n')
            echo "ğŸ“„ Current APK signature SHA-256:"
            echo "$CURRENT_FINGERPRINT"
            
            # FINGERPRINT GATE: Critical consistency check
            if [ -n "${{ secrets.GOLDEN_FINGERPRINT }}" ]; then
              echo "ğŸš¨ FINGERPRINT GATE ACTIVATED - Comparing with golden baseline..."
              GOLDEN_FINGERPRINT="${{ secrets.GOLDEN_FINGERPRINT }}"
              
              echo "$GOLDEN_FINGERPRINT" > expected.sha256
              echo "$CURRENT_FINGERPRINT" > current.sha256
              
              if diff -q expected.sha256 current.sha256 >/dev/null 2>&1; then
                echo "âœ… FINGERPRINT GATE PASSED - Signature matches golden baseline"
                echo "ğŸ¯ This APK will seamlessly update existing installations"
                echo "ğŸ”’ Signature consistency verified - build approved"
              else
                echo "âŒ FINGERPRINT GATE FAILED - SIGNATURE MISMATCH DETECTED"
                echo "   Golden (Expected): $GOLDEN_FINGERPRINT"
                echo "   Current (Actual):  $CURRENT_FINGERPRINT"
                echo ""
                echo "ğŸš¨ CRITICAL FAILURE: This APK will break existing installations"
                echo "ğŸ“‹ Signing configuration has changed - UPDATE COMPATIBILITY LOST"
                echo ""
                
                # Fail the build on signature mismatch (strict gate)
                if [ "${{ env.SIGNING_MODE }}" = "github-secrets-persistent" ]; then
                  echo "ğŸ’¥ BUILD TERMINATED: Golden fingerprint mismatch in persistent signing mode"
                  echo "ğŸ”§ Fix: Verify keystore restoration and GitHub Secrets configuration"
                  exit 1
                else
                  echo "âš ï¸ WARNING: Bootstrap mode - signature mismatch expected on first run"
                  echo "ğŸ’¡ Action: After verifying this build, set GOLDEN_FINGERPRINT secret to:"
                  echo "   $CURRENT_FINGERPRINT"
                fi
              fi
              
              # Clean up temp files
              rm -f expected.sha256 current.sha256
            else
              echo "ğŸ“‹ No golden fingerprint configured - gate bypassed"
              echo "ğŸ’¡ TO ENABLE FINGERPRINT GATE:"
              echo "   Add GOLDEN_FINGERPRINT secret with value: $CURRENT_FINGERPRINT"
              echo ""
              
              if [ "${{ env.SIGNING_MODE }}" = "github-secrets-persistent" ]; then
                echo "ğŸ¯ First build with persistent signing - establishing golden baseline"
                echo "ğŸ”‘ Store this fingerprint as GOLDEN_FINGERPRINT for future builds"
              else
                echo "âš ï¸ Bootstrap mode: fingerprint will change on next build"
                echo "ğŸ”§ Configure GitHub Secrets for permanent baseline establishment"
              fi
            fi
            
            # Export fingerprint for release notes and logging
            echo "CURRENT_FINGERPRINT=$CURRENT_FINGERPRINT" >> $GITHUB_ENV
            echo "ğŸ” Signature fingerprint exported for release documentation"
          else
            echo "âš ï¸ apksigner not available - fingerprint gate disabled"
            echo "CURRENT_FINGERPRINT=unavailable" >> $GITHUB_ENV
          fi

      - name: ğŸ•µï¸ Analyze APK Contents
        run: |
          echo "--- Analyzing content of APK file ---"
          APK_FILE=$(find . -name "lamidash_*.apk" | head -n 1)
          if [ -f "$APK_FILE" ]; then
            echo "ğŸ“Š APK Contents Analysis for: $APK_FILE"
            unzip -l "$APK_FILE"
            echo ""
            echo "ğŸ“ˆ Top 20 largest files in APK:"
            unzip -l "$APK_FILE" | sort -k1 -nr | head -n 20
          else
            echo "APK file not found for analysis."
          fi
          echo "--- End of APK Content Analysis ---"

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_FILE }}
          path: ${{ env.APK_FILE }}

      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: Laminator Dashboard ${{ env.VERSION_TAG }}
          files: ${{ env.APK_FILE }}
          body: |
            # ğŸ›ï¸ Laminator Dashboard ${{ env.VERSION_TAG }}
            
            ## ğŸ” Advanced Signature System Implementation
            
            **Signing Mode**: `${{ env.SIGNING_MODE }}`  
            **Signature SHA-256**: `${{ env.CURRENT_FINGERPRINT }}`
            
            ### ğŸ“‹ Installation Instructions
            
            #### ğŸ¯ If Signing Mode = `github-secrets-persistent`:
            **âœ… SEAMLESS UPDATES ENABLED** - This APK should update existing installations without uninstalling.
            
            #### âš ï¸ If Signing Mode = `bootstrap-temporary`:
            **ğŸš¨ ONE-TIME MIGRATION REQUIRED** - You must uninstall the existing app before installing this version.
            
            **Migration Steps for Bootstrap Mode**:
            1. ğŸ’¾ **BACKUP YOUR DATA** using the app's backup function
            2. ğŸ—‘ï¸ Uninstall existing Laminator Dashboard
            3. â¬‡ï¸ Download and install this APK
            4. ğŸ“„ Restore your data using the backup function
            
            #### ğŸ†• For New Users:
            1. â¬‡ï¸ Download the APK file
            2. ğŸ”“ Enable "Install from Unknown Sources"
            3. ğŸ“± Install the APK
            
            ## ğŸ›¡ï¸ Advanced Signature Management System
            
            ### ğŸ”‘ Keystore Persistence Technology
            - **GitHub Secrets Integration**: Keystore stored as base64-encoded secret
            - **Environment Variable Validation**: Full validation chain in Gradle
            - **Signature Fingerprint Verification**: Automated consistency checking
            - **Bootstrap Fallback**: Temporary keystore for initial setup
            - **Cross-Build Consistency**: Same signature across all CI runs
            
            ### ğŸ“Š Signature Verification Results
            ```
            Current Fingerprint: ${{ env.CURRENT_FINGERPRINT }}
            Signing Mode: ${{ env.SIGNING_MODE }}
            Keystore Type: ${{ env.SIGNING_MODE == 'github-secrets-persistent' && 'Persistent (GitHub Secrets)' || 'Temporary Bootstrap' }}
            Update Compatibility: ${{ env.SIGNING_MODE == 'github-secrets-persistent' && 'âœ… Seamless Updates' || 'âš ï¸ Manual Reinstall Required' }}
            ```
            
            ### ğŸ”§ For Developers: Setting Up Persistent Signing
            
            If this build shows `bootstrap-temporary` mode, configure GitHub Secrets:
            
            ```bash
            # 1. Generate permanent keystore
            keytool -genkeypair -v -keystore laminator-official.keystore \
              -alias laminator-official -keyalg RSA -keysize 4096 -validity 36500 \
              -dname "CN=Laminator Dashboard,O=BochangDev,C=JP" \
              -storepass YOUR_PASSWORD -keypass YOUR_PASSWORD
            
            # 2. Encode to base64
            base64 -w 0 laminator-official.keystore   # Linux
            base64 laminator-official.keystore | tr -d '\n'   # macOS
            
            # 3. Add GitHub Secrets:
            KEYSTORE_B64: [base64 encoded keystore]
            KEYSTORE_PASSWORD: [your password]
            KEY_ALIAS: laminator-official  
            KEY_PASSWORD: [your key password]
            SIGNING_FINGERPRINT: ${{ env.CURRENT_FINGERPRINT }}
            ```
            
            ## ğŸš€ App Features
            - â° **Production Time Calculator** - Accurate completion predictions
            - ğŸï¸ **Film Session Management** - Material consumption tracking
            - ğŸ“‹ **Real-time Job Tracking** - Live progress monitoring
            - ğŸ“Š **Efficiency Analytics** - Comprehensive work reports
            - ğŸŒ **PWA Technology** - Offline functionality + home screen install
            - ğŸ’¾ **Data Backup/Restore** - Full data preservation system
            
            ## ğŸ”§ Technical Specifications
            - **Framework**: Capacitor 7.4.2 + Android API 35
            - **Build Environment**: Node.js ${{ env.NODE_VERSION }} + Java ${{ env.JAVA_VERSION }}
            - **Signing Method**: ${{ env.SIGNING_MODE == 'github-secrets-persistent' && 'ğŸ” GitHub Secrets Persistent' || 'ğŸ—ï¸ Bootstrap Temporary' }}
            - **APK Type**: ${{ env.BUILD_TYPE == 'release' && 'ğŸ” Release Build' || 'ğŸ”§ Debug Build' }}
            - **Architecture**: Environment Variable + Gradle Validation Chain
            - **Compatibility**: Android 7.0+ (API 24+)
            
            ## ğŸ“ˆ Build Information
            - **Version**: ${{ env.VERSION_TAG }}
            - **Build Number**: ${{ github.run_number }}
            - **Signature**: ${{ env.CURRENT_FINGERPRINT }}
            - **Build Mode**: ${{ env.SIGNING_MODE }}
            - **Commit**: ${{ github.sha }}
            
            ## ğŸ¯ Signature System Advantages
            - **Permanent Solution**: Once configured, works forever
            - **CI/CD Integration**: Full automation with validation
            - **Update Compatibility**: Seamless APK updates for users
            - **Fingerprint Verification**: Prevents accidental signature breaks
            - **Developer Friendly**: Clear setup instructions and debugging
            
            ---
            ğŸ¤– **Auto Build**: GitHub Actions Advanced Signature System  
            ğŸ“… **Build Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
            ğŸ† **Achievement**: Complete signature consistency solution implemented
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}